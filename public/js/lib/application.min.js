function isInArray(a,b){return result=b.indexOf(a)>-1,result}function minutesToStr(a){var b="";a<0&&(b="-");var c=Math.floor(Math.abs(a)/60),a=leftPad(Math.abs(a)%60);return b+c+" h "+a+" min"}function leftPad(a){return(a<10&&a>=0?"0":"")+a}function invoiceValue(a,b){if("undefined"==typeof b&&(b="DKK"),null!=a.NetAmount&&null!=a.VatAmount){var c=Number(a.NetAmount)+Number(a.VatAmount);return c.toLocaleString("da")+" "+b}return""}function hashDiff(a,b){var d,c={};for(d in b)a[d]!==b[d]&&(c[d]=b[d]);return c}function convertSerializedArrayToHash(a){for(var b={},c=0;c<a.length;c++)b[a[c].name]=a[c].value;return delete b._token,b}function addhttp(a){return/^(f|ht)tps?:\/\//i.test(a)||(a="http://"+a),a}function validateUrl(a){return a.match(re_weburl)}function validateEmail(a){var b=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return b.test(a)}function handleError(a,b,c){}function saveError(a){var b={Module:getModel(),ItemId:getModelId(),Error:a,User_Id:getUserId()};$.ajax({method:"POST",url:api_address+"Logs",data:JSON.stringify(b),suppressErrors:!0,saveError:!1,success:function(a){},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function toDateTime(a){var b=new Date(a);return b.toDateTime()}function toDate(a){var b=new Date(a);return b.toDate()}function monthsListBetweenDates(a,b){for(var c=moment(a),d=moment(b),e=[];d>c;)e.push(c.format("YYYY-M")),c.add(1,"month");return e}function getYearsSelect(a){var b=(new Date).getFullYear(),c=[];for(a=a||b-2;a<=b+2;)c.push(a++);return c}function leftbarScrollShow(){$("body").hasClass("show-leftbar")?$("#sidebar").getNiceScroll().show():$("#sidebar").getNiceScroll().hide(),$("#sidebar").getNiceScroll().resize()}function leftbarTopPos(){var a=$("body.static-header").scrollTop();a<41?$("ul#sidebar").css("top",40-a+"px"):$("ul#sidebar").css("top",0)}function rightbarTopPos(){var a=$("body.static-header").scrollTop();a<41?$("#page-rightbar").css("top",40-a+"px"):$("#page-rightbar").css("top",0)}function rightbarRightPos(){if($("body").hasClass("fixed-layout")){var a=$("#page-content"),b=$(window).width()-(a.offset().left+a.outerWidth());b<0&&(b=0),$("#page-rightbar").css("right",b)}}function checkpageheight(){sh=$("#page-leftbar").height(),ch=$("#page-content").height(),sh>ch&&$("#page-content").css("min-height",sh+"px")}function widgetheight(){$("#widgetarea").css({"max-height":$("body").height()}),$("#widgetarea").getNiceScroll().resize()}function initContractFieldValues(){var b=($(".contractFieldValuesPlaceholder"),getModelId());$.get("Contracts("+b+")/FieldValues").success(function(a){})}function splitTimelineIntoMonths(){var a=$(".timelineItem");a.wrapAll("<div id='accordioninpanel' class='accordion-group'></div>");var b=[];$.each(a,function(a,c){var d=moment($(c).data("date")).month(),e=moment($(c).data("date")).year(),f="month_"+e+"_"+d;isInArray(f,b)||b.push(f),$(c).addClass(f)}),$.each(b,function(a,b){var c=$("."+b),d=Number(b.substring(11))+1,e=moment(d,"MM").format("MMMM"),f=Number(b.substring(6,10)),g=moment(f,"YYYY").format("YYYY");0==$(".grouped_"+b).length&&$('<div class="accordion-item grouped_'+b+'"> <a class="accordion-title text-center" data-toggle="collapse" data-parent="#accordioninpanel" href="#collapsein'+b+'"><h4>'+e+" "+g+'</h4></a> <div id="collapsein'+b+'" class="collapse"><div class="accordion-body">').insertBefore(c[0]),c.prependTo($(".grouped_"+b).find(".accordion-body")),$(".panel-timeline").removeClass("spinner")});var c=$(".accordion-item");$.each(c,function(a,b){$(b).find(".accordion-title").addClass("collapsed"),$(b).find(".collapse").removeClass("in")}),$(c[0]).find(".accordion-title").removeClass("collapsed"),$(c[0]).find(".collapse").addClass("in"),setTimeLineBorders()}function timelineTasks(){var a=getModel(),b=getModelId();return $.get(api_address+"TaskLists?$filter=Model eq '"+a+"' and ModelId eq "+b+" and Value eq true&$expand=Parent($select=Id,Title),CompletedBy($select=FullName)")}function timelineComments(){var a=getModel(),b=getModelId();return $.get(api_address+"Comments?$filter=(Type eq 'Public') and Model eq '"+a+"' and ModelId eq "+b+" and User_Id ne null&$expand=Children($select=Id,Message,Created,ParentCommentId;$expand=User($select=UserName,FullName)),User($select=FullName,UserName)&$select=Id,Message,Model,ModelId,Created&$orderby=Created desc")}function timelinePayments(){return $.get(api_address+"Invoices?$filter=InvoiceLine/any(d:d/Contract_Id eq "+getModelId()+")&$expand=User($select=FullName)&$select=InvoiceNumber,Id,Payed,Created,Status,Type")}function timelineTimeLogs(){var a={Model:getModel(),Item:getModelId()};return $.ajax({url:api_address+"TimeVaults/RetrieveTransactions?$expand=Comment($select=Message),User($select=FullName)",type:"POST",data:JSON.stringify(a),beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function getTimeregStatus(){return $.get(api_address+"TimeRegistrations/CurrentStatus")}function openTimeVaultMenu(a){var b=getDefaultModal(),c=b.find(".modal-body");b.find(".modal-title").text("Time logs");c.loadTemplate(base_url+"/templates/timeVaults/menu.html",{VaultId:a},{success:function(){$("#TimeVaultTransactionsTable").DataTable({bPaginate:!1,bInfo:!1,bFilter:!1,iDisplayLength:"All",aaSorting:[[0,"desc"]],bProcessing:!0,bServerSide:!0,deferRender:!0,sAjaxSource:api_address+"TimeVaults("+a+")/Transactions?$expand=User($select=FullName),Comment($select=Message)",aoColumns:[{mData:"Created",mRender:function(a){return toDateTime(a)}},{mData:"Amount",mRender:function(a){return minutesToStr(a)}},{mData:null,oData:"User/FullName",mRender:function(a){return a.User.FullName}},{mData:null,oData:"Comment/Message",sClass:"multiline",mRender:function(a){return a.Comment?a.Comment.Message:""}}],fnServerData:fnServerOData,iODataVersion:4,bUseODataViaJSONP:!1})}})}function loadOrders(){var a=getModelId(),b=$("#orders").find(".table-responsive");b.loadTemplate(base_url+"/templates/orders/ordersTabTable.html",{},{success:function(){$("#ordersTabTable").DataTable({bPaginate:!1,bInfo:!1,bFilter:!1,iDisplayLength:"All",responsive:!0,stateSave:!0,aaSorting:[[2,"desc"]],bProcessing:!0,bServerSide:!0,deferRender:!0,sAjaxSource:api_address+"Orders?$expand=User($select=Id,FullName),OrderProduct($select=Id;$expand=Product($select=Name)),OrderProductPackage($select=Id;$expand=ProductPackage($select=Name))",filter:"ClientAlias_Id eq "+a,select:"ArchivedDate",fnRowCallback:function(a,b){b.ArchivedDate&&$(a).addClass("danger").prop("title","Order is archived")},aoColumns:[{mData:"Id",mRender:function(a){return"<a target='_blank' href='"+linkToItem("Order",a,!0)+"'>"+a+"</a>"}},{mData:null,oData:"User/FullName",mRender:function(a){return"<a target='_blank' href='"+linkToItem("User",a.User.Id,!0)+"'>"+a.User.FullName+"</a>"}},{mData:"Created",sType:"date",mRender:function(a){return new Date(a).toDateTime()}},{mData:"ConfirmedDate",sType:"date",mRender:function(a){return null!=a?new Date(a).toDateTime():""}},{mData:null,oData:null,mRender:function(a){var b="",c="";return a.OrderProduct.length>0&&$.each(a.OrderProduct,function(a,c){b+=c.Product.Name+"</br>"}),a.OrderProductPackage.length>0&&$.each(a.OrderProductPackage,function(a,b){c+=b.ProductPackage.Name+"</br>"}),b+" "+c}}],fnServerData:fnServerOData,iODataVersion:4,bUseODataViaJSONP:!1})}})}function initAttendeesInput(){$("#tokenfield-email").on("beforeCreateToken",function(a){var b=a.token.value.split("|");a.token.value=b[1]||b[0],a.token.label=b[1]?b[0]+" ("+b[1]+")":b[0]}).on("afterCreateToken",function(a){validateEmail(a.token.value)||$(a.relatedTarget).addClass("invalid")}).on("beforeEditToken",function(a){if(a.token.label!==a.token.value){var b=a.token.label.split(" (");a.token.value=b[0]+"|"+a.token.value}}).on("preventDuplicateToken",function(a){new PNotify({title:"This email is already an attendee! "+a.token.value,type:"error"})}).tokenfield()}function loadDraftsTab(){var a=getModel(),b=getModelId(),c="";"Contract"==a?c+="DraftLine/any(d:d/Contract_Id eq "+b+")":"ClientAlias"==a&&(c+="ClientAlias_Id eq "+b);var d=$("#draftsTab").find(".table-responsive");d.loadTemplate(base_url+"/templates/drafts/draftsTabTable.html",{},{success:function(){$("#draftsTabTable").DataTable({bPaginate:!1,bInfo:!1,bFilter:!1,iDisplayLength:"All",responsive:!0,stateSave:!0,aaSorting:[[2,"asc"]],bProcessing:!0,bServerSide:!0,deferRender:!0,filter:"(Status ne 'Deleted' and Status ne 'Invoice') and "+c,sAjaxSource:api_address+"Drafts?$expand=DraftLine($expand=Product)",aoColumns:[{mData:"Id",mRender:function(a){return"<a target='_blank' href='"+linkToItem("Draft",a,!0)+"'>"+a+"</a>"}},{mData:"Created",sType:"date",mRender:function(a){return new Date(a).toDateTime()}},{mData:"NoticeAccountant",sType:"date",mRender:function(a){return null!=a?new Date(a).toDateTime():"-"}},{mData:null,oData:null,sortable:!1,mRender:function(a){var b="";return a.DraftLine.length>0&&$.each(a.DraftLine,function(a,c){b+=c.Product?c.Product.Name+" x "+c.Quantity+" months x "+Number(c.UnitPrice).format(!0)+" DKK <br>":"No product for draft line "+c.Id+"<br>"}),b}}],fnServerData:fnServerOData,iODataVersion:4,bUseODataViaJSONP:!1})}})}function getEligableDiscount(a){var b=a||getModelId();return $.get(api_address+"ClientAlias("+b+")/EligibleDiscountProcentage")}function formatPhoneNumber(a){return a.replace("+","").replace(/\D/g,"")}function createCallingLink(a,b){return null==b?"":a?"<span class='pseudolink flexfoneCallOut'>"+formatPhoneNumber(b)+"</span>":"<a href='tel:"+formatPhoneNumber(b)+"'>"+b+"</a>"}function canCall(){return $("#user-LocalNumber").val()}function getIsoDate(a){if(a){var b=new Date(a);return b.toISOString()}var b=new Date;return b.toISOString()}function createEvent(a){$.post(base_url+"/calendar/create-event",a).success(function(a){refreshCalendar(),closeDefaultModal()})}function fingUserByLocalNumber(a){return $.get(api_address+"Users?$select=FullName,Id&$filter=EmployeeLocalNumber eq "+a+"&$top=1")}function refreshCalendar(){var a=$(".responsive-iframe-container");openCalendarIFrame(getUserName(),a)}function sortMyTasks(){var a=$("#myTaskBody"),b=a.find(".rightMenuTaskContainer").filter(function(){return void 0!==$(this).data("dueDate")});b.sort(function(a,b){var c=new Date(a.dataset.dueDate),d=new Date(b.dataset.dueDate);return d<c?1:-1}).prependTo(a)}function sortDashboardTasks(){var a=$(".panel-tasks"),b=a.find(".DashboardTask").filter(function(){return void 0!==$(this).data("dueDate")});b.sort(function(a,b){var c=new Date(a.dataset.dueDate),d=new Date(b.dataset.dueDate);return d<c?1:-1}).prependTo(a)}function dashboardTasks(){var a=$(".panel-tasks");a.empty();var b=getUserId(),c="(AssignedTo_Id eq '"+b+"' and ParentTaskListId eq null) or (ParentTaskListId ne null and AssignedTo_Id eq '"+b+"' and Parent/AssignedTo_Id ne '"+b+"' and Value eq false)";$.get(api_address+"TaskLists?$filter=Value eq false and "+c+"&$expand=Children($filter=Value eq false)&$top=10&$orderby=DueTime desc,Created").success(function(b){var c=[];$.each(b.value,function(a,b){var d={};b.DueTime&&(d.Due="Due: "),b.Model&&b.ModelId&&(d.TaskModel=b.Model,d.TaskModelId=b.ModelId),d.Title=b.Title+(b.Children.length>0?" ("+b.Children.length+")":""),d.Id=b.Id,d.taskLink=base_url+"/tasks/show/"+b.Id,d.DueTime=b.DueTime,d.Description=b.Description,c.push(d)}),a.loadTemplate(base_url+"/templates/tasks/dashboardTask.html",c,{append:!0,success:function(){sortDashboardTasks()}})})}function initializeAdminMenu(){$.get(base_url+"/app/userRelations/"+getModel()).success(function(a){$.when($.get(base_url+"/users/getList")).then(function(b){var c=$.parseJSON(b),d=$(".adminUserAssign"),e=JSON.parse(a);e.forEach(function(a){d.loadTemplate(base_url+"/templates/admin/userSelect.html",{Name:a[1],Label:a[0],FormName:a[0]+a[1]},{append:!0,success:function(){d=$("#"+a[0]+a[1]).find("select");for(var b in c)d.append($("<option></option>").attr("value",b).text(c[b]))}})})})}),$("#adminModelName").text(getModel())}function adminUserAssigned(a){var b=a.serializeJSON(),c=getModel();"ClientAlias"==c?$.ajax({url:api_address+"ClientAlias("+getModelId()+")/Move",type:"POST",data:JSON.stringify(b),success:function(){new PNotify({title:"Updated. Refreshing..."}),location.reload(!0)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}}):"Contract"==c?$.ajax({url:api_address+"Contracts("+getModelId()+")/Move",type:"POST",data:JSON.stringify(b),success:function(){new PNotify({title:"Updated. Refreshing..."}),location.reload(!0)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}}):$.ajax({url:api_address+("ClientAlias"==getModel()?"ClientAlias":getModel()+"s")+"("+getModelId()+")",type:"Patch",data:JSON.stringify(b),success:function(){new PNotify({title:"updated"})},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function openCheckListMenu(){var a=getDefaultModal();a.find(".modal-title").append(Lang.get("labels.add-checklist")),a.find(".modal-body").loadTemplate(base_url+"/templates/tasks/checklistForm.html",{ChecklistGroupLabel:Lang.get("labels.checklist-group-name"),SaveLabel:Lang.get("labels.save"),TitleLabel:Lang.get("labels.title"),DescriptionLabel:Lang.get("labels.description"),Model:getModel(),ModelId:getModelId()},{append:!0,success:function(){$.get(base_url+"/users/getList").success(function(a){var b=JSON.parse(a),c=$("#checklistItem-AssignedTo_Id"),d=$("#checklist-AssignedTo_Id");for(var e in b)c.append($("<option></option>").attr("value",e).text(b[e]));for(var e in b)d.append($("<option></option>").attr("value",e).text(b[e]))})}})}function setFavicon(){var a=$('link[type="icon"]').remove().attr("href");$('<link href="'+a+'" rel="icon"  type="icon" />').appendTo("head")}function updateTask(a,b){var c=$(a.target).find("input:submit");c.prop("disabled",!0);for(var d in b)""===b[d]&&(b[d]=null);var e=b.TaskId;delete b.TaskId;var f=!!b.UpdateRow;delete b.UpdateRow,b.StartTime&&(b.StartTime=moment(b.StartTime)),b.DueTime&&(b.DueTime=moment(b.DueTime));var g=!!b.ForItem;return delete b.ForItem,b.NotifyCreator=!!b.NotifyCreator,$.ajax({url:api_address+"TaskLists("+e+")",type:"Patch",data:JSON.stringify(b),success:function(a){closeDefaultModal(),$("body").hasClass("show-rightbar")&&myTasks(),g&&itemTasks(b.Model,b.ModelId),f&&getModelId()?subtaskstable.draw():"TaskList"==getModel()&&tasksTable.draw(),$(".panel-tasks").length>0&&dashboardTasks(),c.prop("disabled",!1)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function addAttendee(a){var b=$("input[name='Attendees[EMail]']").map(function(){return $(this).val()}).get();return isInArray(a,b)?(new PNotify({title:Lang.get("labels.error"),text:Lang.get("labels.already-attendee"),type:"error"}),!1):void $("#appointment-Attendees").loadTemplate(base_url+"/templates/appointmentAttendee.html",{AttendeeEmail:a},{append:!0,success:function(){$("#add-attendee-field").val("")}})}function initializeSeoChecklist(){var a=getModel(),b=getModelId();$.get(api_address+"TaskLists?$filter=ParentTaskListId eq null and Model eq '$model' and ModelId eq $modelId".replace("$model",a).replace("$modelId",b)+"&$expand=Children($orderby=Value,SortOrder asc)&$orderby=Value").success(function(a){a.value.length>0&&renderChecklistItems(a.value)})}function renderChecklistItems(a){var b=$(".seoChecklist");a.forEach(function(a,c){var d="";a.Value&&(d="completedSeo");var e={Link:linkToItem("TaskList",a.Id,!0),Id:a.Id,Title:a.Title,Description:a.Description,Checked:a.Value,Hidden:d};b.loadTemplate(base_url+"/templates/tasks/checklistGroup.html",e,{append:!0,success:function(){var b=$(".seoChecklist > .completedSeo"),c=$('.checklistParent[value="'+a.Id+'"]').closest(".form-group").find(".checklistChildren");if(c.length>0&&a.Children.length>0){var d=$.map(a.Children,function(b){var c={Id:b.Id,Title:b.Title,Description:b.Description};return a.Value&&(c.Disabled=a.Value),c.Checked=b.Value,c});c.loadTemplate(base_url+"/templates/tasks/checklistItem.html",d,{prepend:!0})}b.hide(),b.length>0&&$("#showCompletedCheckList").prop("disabled",!1)}})})}function quickEditTask(a,b){var c=getDefaultModal(),e=(c.find(".modal-body"),c.find(".modal-title"));e.append(Lang.get("labels.edit-task")+" "+linkToItem("TaskList",a)),$.when($.get(api_address+"TaskLists("+a+")?$expand=Children").success(function(a){return a})).then(function(a){if(null!=a.StartTime){var d=moment(a.StartTime);a.StartTime=d.format("YYYY/MM/DD HH:mm")}if(null!=a.DueTime){var e=moment(a.DueTime);a.DueTime=e.format("YYYY/MM/DD HH:mm")}var f={TaskId:a.Id,ItemLabel:Lang.get("labels.item"),Model:a.Model,ModelId:a.ModelId,TitleLabel:Lang.get("labels.title"),Title:a.Title,DescriptionLabel:Lang.get("labels.description"),Description:a.Description,StartTimeLabel:Lang.get("labels.start-time"),StartTime:a.StartTime,DueTimeLabel:Lang.get("labels.due-time"),DueTime:a.DueTime,UserLabel:"Assigned to",AssignedTo_Id:a.AssignedTo_Id,NotifyCreator:a.NotifyCreator?"checked":null,SortOrder:a.SortOrder};b&&(f.Row="true"),c.find(".modal-body").loadTemplate(base_url+"/templates/tasks/taskEditForm.html",f,{overwriteCache:!0,success:function(){$.get(base_url+"/users/getList").success(function(b){var c=JSON.parse(b),d=$("#quickTaskEditForm").find("#task-AssignedTo_Id");for(var e in c)d.append($("<option></option>").attr("value",e).text(c[e]));d.val(a.AssignedTo_Id)}),$(".datetimepicker").datetimepicker({changeMonth:!0,changeYear:!0,showButtonPanel:!0,minDate:"-1970/01/01",allowTimes:allowedTimes()})}})})}function openCreateOrderModal(){$.ajax({url:api_address+"OrderTypes?$select=Id,FormName",type:"GET",success:function(a){var b=[];b.push({FormName:Lang.get("labels.default"),link:base_url+"/orders/create"}),a.value.forEach(function(a){b.push({FormName:a.FormName,link:base_url+"/orders/create/"+a.Id})});var c=$("#defaultModal").modal();return c.find(".modal-title").empty().append(Lang.get("labels.create-order")),c.find(".modal-body").empty().loadTemplate(base_url+"/templates/createOrderLink.html",b,{prepend:!0}),!1},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function openCalendarIFrame(a,b){"undefined"==typeof b&&(b=$("#calendarIFrame")),b.empty().append('<iframe src="https://www.google.com/calendar/embed?showTitle=0&amp;showDate=1&amp;showPrint=1&amp;showCalendars=0&amp;showTz=0&amp;height=400&amp;wkst=2&amp;bgcolor=%23FFFFFF&amp;src='+a+'@greenclickmedia.dk&amp;color=%232F6309&amp;ctz=Europe%2FCopenhagen&output=embed" style="border-width: 0;width: 100%;height:400px;"></iframe>')}function deleteFile(a){var b=$(a.target).closest("tr").data("file-id");return bootbox.confirm("Are you sure?",function(c){c&&$.ajax({url:api_address+"FileStorages("+b+")",type:"DELETE",success:function(){$(a.target).closest("tr").remove()},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}),!1}function initializeDropzone(){Dropzone.autoDiscover=!1;var a=$("#Model").val(),b=$("#ModelId").val(),c=new Dropzone("#itemFileUploadForm",{url:api_address+"FileStorages",maxFilesize:100,headers:{Authorization:"Bearer "+$.cookie("auth")}});c.on("addedfile",function(a){a.previewElement.addEventListener("click",function(){c.removeFile(a)})}),c.on("complete",function(d){var e=JSON.parse(d.xhr.response),f=e.Id;$.ajax({url:api_address+"FileStorages("+f+")",type:"PATCH",data:JSON.stringify({Model:a,ModelId:b}),success:function(){var a=$("#item-files").find("tbody"),b=new Date(e.Created);a.length>0&&a.loadTemplate(base_url+"/templates/uploadedFile.html",{Created:b.toDateTime(),FileId:e.Id,PreviewLabel:Lang.get("labels.preview"),Name:e.Name,FullName:$("#user-FullName").val(),UserName:$("#user-UserName").val(),DownloadLabel:Lang.get("labels.download"),DeleteLabel:Lang.get("labels.delete")},{prepend:!0})},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}}),c.removeFile(d)}),c.on("error",function(a){handleError(a)});var d=$("label[for='selectAllFiles']");d.text("Select all"),body.on("change","#selectAllFiles",function(a){var b=$(a.target),c=b.prop("checked");c?($(".fileCheckBox").prop("checked",!0),d.text("Unselect all")):($(".fileCheckBox").prop("checked",!1),d.text("Select all"))}),body.on("change",".fileCheckBox",function(a){$(".fileCheckBox:checked").length==$(".fileCheckBox").length?($("#selectAllFiles").prop("checked",!0),d.text("Unselect all")):($("#selectAllFiles").prop("checked",!1),d.text("Select all"))}),$("#dlSelectedFiles").on("click",function(a){var b=$(".fileCheckBox:checked").toArray(),c=$.map(b,function(a){return"file[]="+a.value});window.open(base_url+"/files/bulk-download?"+c.join("&"),"myWindow","width=500,height=500,scrollbars=yes").focus()})}function deleteContact(a){var b=$(a.target).closest(".deleteContactBtn").data("contact-id");return bootbox.confirm("Are you sure?",function(a){a&&$.ajax({url:api_address+"Contacts("+b+")",type:"DELETE",success:function(){contactsTable.draw()},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}),!1}function saveContact(a){a.preventDefault();var b=$(a.target),c=b.find(":submit"),d=convertSerializedArrayToHash(b.serializeArray());delete d._token;for(var e in d)""===d[e]&&delete d[e];if(d.Facebook&&(d.Facebook=addhttp(d.Facebook),!validateUrl(d.Facebook))){var f=$("#contact-Facebook");return f.focus(),f.closest(".form-group").addClass("has-error"),void new PNotify({title:"Enter a valid Facebook link",type:"error"})}if(d.LinkedIn&&(d.LinkedIn=addhttp(d.LinkedIn),!validateUrl(d.LinkedIn))){var g=$("#contact-LinkedIn");return g.focus(),g.closest(".form-group").addClass("has-error"),void new PNotify({title:"Enter a valid LinkedIn link",type:"error"})}c.prop("disabled",!0),$.ajax({type:"POST",url:api_address+"Contacts",data:JSON.stringify(d),success:function(a){b[0].reset(),c.prop("disabled",!1),contactsTable.draw()},error:function(a){c.prop("disabled",!1)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function showIFrame(a){return $("#iframe").show(),$("#frame").attr("src",a),!1}function taskProgress(a,b){var c=0;if(a.Value)c=100;else{var d=a.Children.length;if(d>0){for(var e=0,f=0;f<d;f++)a.Children[f].Value&&e++;c=100*e/d}else c=0}return b?c.toFixed():($(".progressBar[data-task-id='"+a.Id+"']").css("width",c.toFixed()+"%"),void $(".progressP[data-task-id='"+a.Id+"']").html(c.toFixed()+"%"))}function checkTask(a){var b=$(a.target),c=b.prop("checked"),d=b.val(),e=c?"Check":"UnCheck",f=b.hasClass("tableTask"),g=b.hasClass("checklistTask");if(g)var h=b.hasClass("checklistParent");b.prop("disabled",!0),$.ajax({url:api_address+"TaskLists("+d+")/action."+e,type:"POST",success:function(){if($("body").hasClass("show-rightbar")&&!f&&myTasks(),$(".panel-tasks").length>0&&b.closest("li").remove(),taskCountBadge(),f&&(c?b.closest("tr").addClass("crossed-through"):b.closest("tr").removeClass("crossed-through"),b.prop("disabled",!1),$.get(api_address+"TaskLists("+d+")?$select=Id&$expand=Parent($expand=Children($select=Value);$select=Id,Value)").success(function(a){taskProgress(a.Parent)})),g){var a=$('.checklistParent[value="'+d+'"]').closest(".form-group").find(".checklistChildren");"UnCheck"==e&&h?a.find(".checklistTask").prop("disabled",!1):"Check"==e&&h&&a.find(".checklistTask").prop("disabled",!0),b.prop("disabled",!1)}},error:function(b){$(a.target).prop("disabled",!1),new PNotify({title:"Error",text:"Could not check task",type:"error"})},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function itemTasks(a,b){var e=($("#user-Id").val(),$("#itemTasksBody"));e.empty().addClass("spinner"),$.ajax({url:api_address+"TaskLists?$filter=Value eq false and ModelId eq "+b+" and Model eq '"+a+"' and ParentTaskListId eq null&$select=Title,Id,Description,Model,ModelId&$expand=Children($filter=Value eq false),&$orderby=Created",type:"GET",success:function(a){if(a.value.length>0){var b=$.map(a.value,function(a,b){var c={TaskId:a.Id,TaskLink:linkToItem("TaskList",a.Id,!0),TaskTitle:a.Title,Description:a.Description};return a.Model&&a.ModelId&&(c.TaskModel=a.Model,c.TaskModelId=a.ModelId),a.Children.length>0&&(c.SubTasksCount='<i class="fa fa-plus-circle expandTasks"></i>'),c});e.loadTemplate(base_url+"/templates/tasks/task.html",b,{append:!0,success:function(){e.removeClass("spinner")}})}else e.removeClass("spinner").text("There are no tasks for the current item")},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function nextAppointment(a,b){var c=$(".next-appointment");$.ajax({url:api_address+"CalendarEvents/NextAppointment",type:"POST",data:JSON.stringify({Model:a,ModelId:b}),success:function(a){a.value[0]?c.html("<a target='_blank' title='"+(a.value[0].Description||"")+"' href='"+base_url+"/appointments/show/"+a.value[0].Id+"'>"+a.value[0].Summary+" "+toDateTime(a.value[0].Start)+"<a>"):c.html("No future appointments.")},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function myTasks(){var a=getUserId(),b="(AssignedTo_Id eq '"+a+"' and ParentTaskListId eq null) or (ParentTaskListId ne null and AssignedTo_Id eq '"+a+"' and Parent/AssignedTo_Id ne '"+a+"' and Value eq false)",c=$("#myTaskBody");c.empty().addClass("spinner"),$.ajax({url:api_address+"TaskLists?$filter= Value eq false and "+b+"&$select=Title,Id,Description,Model,ModelId,DueTime&$expand=Children($filter=Value eq false)&$orderby=DueTime desc,Created",type:"GET",success:function(a){if(a.value.length>0){var b=$.map(a.value,function(a,b){var c={TaskId:a.Id,TaskTitle:a.Title,TaskLink:linkToItem("TaskList",a.Id,!0),Description:a.Description,DueTime:a.DueTime,Due:a.DueTime?"Due: ":null};return a.Model&&a.ModelId&&(c.TaskModel=a.Model,c.TaskModelId=a.ModelId),a.Children.length>0?c.SubTasksCount='<i class="fa fa-plus-circle expandTasks"></i>':c.SubTasksCount='<i class="fa fa-plus-circle" style="visibility:hidden;"></i>',c});c.loadTemplate(base_url+"/templates/tasks/task.html",b,{overwriteCache:!0,success:function(){sortMyTasks(),c.removeClass("spinner")}})}else c.removeClass("spinner").text("You don't have any tasks yet. Create one above.")},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function expandSubtasks(a){var b=getDefaultModal(150),c=b.find(".modal-body");c.addClass("spinner"),$.when($.get(api_address+"TaskLists("+a+")?$expand=AssignedTo($select=FullName),CreatedBy($select=FullName),Children").success(function(a){return a})).then(function(b){var d={Id:b.Id,TaskLink:base_url+"/tasks/show/"+b.Id,Model:b.Model,Title:b.Title,Description:b.Description,DueTime:b.DueTime,CreatedBy:b.CreatedBy.FullName,Created:b.Created};b.Model&&(d.ModelId=linkToItem(b.Model,b.ModelId,!0),d.ForItem="For item: "),b.AssignedTo?d.AssignedTo=b.AssignedTo.FullName:d.AssignedTo="--",c.loadTemplate(base_url+"/templates/tasks/subtaskModal.html",d,{success:function(){b.Model&&"TaskList"!=b.Model&&$.when(getCompanyName(b.Model,b.ModelId)).then(function(a){a&&$(".taskModelName").append(a.value)}),initalizeSubTasksTable(a,"modalSubTasksTable"),taskProgress(b),c.removeClass("spinner")}})})}function hideThis(a){return a.style.display="none",!1}function initalizeSubTasksTable(a,b){subtaskstable=$("#"+b).DataTable({responsive:!0,bPaginate:!1,aaSorting:[[6,"asc"]],filter:"Created ne null",sAjaxSource:api_address+"TaskLists("+a+")/Children?$expand=AssignedTo($select=FullName),CreatedBy($select=FullName)",select:"Id,Value",bProcessing:!0,iDisplayLength:"All",bServerSide:!0,fnRowCallback:function(a,b){checkedTasks=0,b.Value?($(a).addClass("crossed-through"),checkedTasks++):$(a).removeClass("crossed-through"),b.Model&&b.ModelId&&$.when(getCompanyName(b.Model,b.ModelId)).then(function(c){var d="View";"Undefined"!=c.value&&(d=c.value),$(a).find("td:nth-child(3)").html("<a href='"+linkToItem(b.Model,b.ModelId,!0)+"' target='_blank'>"+d+"</a>")})},aoColumns:[{mData:"Title",sType:"string",mRender:function(a,b,c){return"<a href='"+base_url+"/tasks/show/"+c.Id+"'>"+a+"</a>"}},{mData:"Description",sClass:"show-more-container"},{mData:null,oData:"AssignedTo/FullName",mRender:function(a){return a.AssignedTo?a.AssignedTo.FullName:""}},{mData:null,oData:"CreatedBy/FullName",mRender:function(a){return a.CreatedBy?a.CreatedBy.FullName:""}},{mData:"StartTime",searchable:!1,mRender:function(a){if(null!=a){var b=new Date(a);return b.toDateTime()}return""}},{mData:"DueTime",searchable:!1,mRender:function(a){if(null!=a){var b=new Date(a);return b.toDateTime()}return""}},{mData:"EndTime,SortOrder",oData:null,sortable:!1,searchable:!1,mRender:function(a,b,c){return'<i class="fa fa-times deleteSubTask" title="Delete"></i>/<span title="Edit the sub task" class="pseudolink"><i class="fa fa-pencil quickEditSubTask"></i></span>/<input class="taskCheck tableTask" '+(c.Value?'checked="checked"':"")+' title="Complete the task" type="checkbox" id="task_'+c.Id+'" value="'+c.Id+'">'}}],fnServerData:fnServerOData,iODataVersion:4,bUseODataViaJSONP:!1}).on("draw.dt",function(){$(".show-more-container").more({length:40,ellipsisText:" ...",moreText:'<i class="fa fa-search-plus"></i>',lessText:'<i class="fa fa-search-minus"></i>'})});var c=function(a,b){return b.children().each(function(){$(this).width($(this).width())}),b};$("#"+b+" tbody").sortable({helper:c,opacity:.8,cursor:"move",stop:function(a,b){var c=subtaskstable.row(b.item).data().Id,d=b.item.index();$.ajax({type:"PATCH",url:api_address+"TaskLists("+c+")",data:JSON.stringify({SortOrder:d}),success:function(){},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}})}function userRolesIcons(a){return"todo map roles to icons"}function stopBreak(){$("#overlay, #break-timer").fadeOut(1e3),breakCounter&&clearInterval(breakCounter),$.removeCookie("breakSeconds",{path:"/"})}function paddy(a,b,c){var d="undefined"!=typeof c?c:"0",e=new Array(1+b).join(d);return(e+a).slice(-e.length)}function startBreakCounter(){var a=Math.floor((new Date).getTime()/1e3),b=new Date(1e3*a);if($.cookie("breakSeconds"))var c=$.cookie("breakSeconds");else{c=0;var d=new Date;d.setTime(d.getTime()+36e5),$.cookie("breakSeconds",c,{expires:d,path:"/"})}b.setSeconds(b.getSeconds()-c),breakCounter=window.setInterval(function(){var a=new Date,c=Math.round(a-b),e=new Date(c),f=e.getUTCHours(),g=e.getUTCMinutes();$("#counter").text(paddy(f,2)+":"+paddy(g,2)+":"+paddy(e.getUTCSeconds(),2));var h=60*g+e.getUTCSeconds();$.cookie("breakSeconds",h,{expires:d,path:"/"}),a.getHours()>=12&&a.getHours()<14?f>=1||g>=30?$("#break-timer #counter").css("color","#D10026"):0==f&&g>=20&&$("#break-timer #counter").css("color","#C2AB00"):f>=1||g>=20?$("#break-timer #counter").css("color","#D10026"):0==f&&g>=10&&$("#break-timer #counter").css("color","#C2AB00")},1e3),setTimeout(function(){var a=$('<div id="overlay"></div>');$(a).hide().appendTo("body").fadeIn(1e3),$("#break-timer").fadeIn(1e3)},750)}function loadTimeRegButtons(a){a||(a=$.cookie("timeReg"));var b="";switch(a){case"CheckedIn":b="beginBreak.html",$.removeCookie("breakSeconds",{path:"/"});break;case"CheckedOut":case"Absent":case"Sick":case"Vacation":b="beginWork.html",$.removeCookie("breakSeconds",{path:"/"});break;case"Break":b="endWork.html",startBreakCounter();break;default:b="beginWork.html",$.removeCookie("breakSeconds",{path:"/"})}var c=$(".time-registration");c.children().remove(),c.loadTemplate(base_url+"/templates/timeRegistrations/"+b)}function endWork(){$.ajax({type:"POST",url:api_address+"TimeRegistrations/CheckOut",suppressErrors:!0,success:function(a){new PNotify({title:Lang.get("labels.success"),text:Lang.get("messages.check-out"),type:"success"});var b=$(".time-registration");b.children().remove(),b.loadTemplate(base_url+"/templates/timeRegistrations/beginWork.html",{overwriteCache:!0}),stopBreak(),setTimeRegCookie("CheckedOut"),$.removeCookie("prevStatus",{path:"/"})},error:function(a){new PNotify({title:"Info",text:"You have already checked out"}),loadTimeRegButtons()}})}function beginWork(){"Break"!=$.cookie("timeReg")&&"CheckedIn"!=$.cookie("timeReg")?$.ajax({
    type:"POST",url:api_address+"TimeRegistrations/CheckIn",suppressErrors:!0,success:function(a){new PNotify({title:Lang.get("labels.success"),text:Lang.get("messages.check-in"),type:"success"});var b=$(".time-registration");b.children().remove(),b.loadTemplate(base_url+"/templates/timeRegistrations/beginBreak.html"),stopBreak(),setTimeRegCookie("CheckedIn"),$.removeCookie("prevStatus",{path:"/"}),setPrevStatusCookie("CheckedOut")},error:function(a){new PNotify({title:"Info",text:"You have already checked in"}),loadTimeRegButtons()}}):$.ajax({type:"POST",url:api_address+"TimeRegistrations/EndBreak",suppressErrors:!0,success:function(a){new PNotify({title:Lang.get("labels.success"),text:"Enjoy the rest of your work!",type:"success"});var b=$(".time-registration");b.children().remove(),b.loadTemplate(base_url+"/templates/timeRegistrations/beginBreak.html"),stopBreak(),setTimeRegCookie("CheckedIn"),$.removeCookie("prevStatus",{path:"/"}),setPrevStatusCookie("Break")},error:function(a){"Break"==$.cookie("prevStatus")?(new PNotify({title:"Info",text:"You have already ended your break"}),stopBreak()):new PNotify({title:Lang.get("labels.error"),text:"You have already checked in"}),loadTimeRegButtons()}})}function beginBreak(){$.ajax({type:"POST",url:api_address+"TimeRegistrations/BeginBreak",suppressErrors:!0,success:function(a){new PNotify({title:Lang.get("labels.success"),text:"Enjoy your break",type:"success"});var b=$(".time-registration");b.children().remove(),b.loadTemplate(base_url+"/templates/timeRegistrations/endWork.html"),setTimeRegCookie("Break"),startBreakCounter(),$.removeCookie("prevStatus",{path:"/"})},error:function(a){new PNotify({title:"Info",text:"You have already begun your break"}),loadTimeRegButtons()}})}function setTimeRegCookie(a){var b=new Date;b.setTime(b.getTime()+72e5),$.cookie("timeReg",a,{expires:b,path:"/"})}function setPrevStatusCookie(a){var b=new Date;b.setTime(b.getTime()+72e5),$.cookie("prevStatus",a,{expires:b,path:"/"})}function getNotifications(){$.ajax({type:"GET",url:api_address+"Notifications/action.Latest",success:function(a){renderNotifications(a)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function renderNotifications(a){var b=$(".headerNotifications"),c=b.find(".notifications-count-badge");c.empty();var d=b.find(".notifications-count-message");d.empty();var e=b.find(".notifications-list");e.empty();var f=0,g=a.value,i=[];g.forEach(function(a){var b="",c="";null==a.Read&&(++f,b="active"),c=a.Id;var d=new Date(a.Created);null==a.IconHtml&&(a.IconHtml="<i class='fa fa-exclamation'></i>");var e=null==a.Model?"notification-default":"notification-"+a.Model.toLowerCase(),g={Content:a.Content,NotificationClasses:e+" "+b,NotiId:c,NotiTime:d.toDateTime(),Title:a.Title};i.push(g)}),f>0&&c.append(f),d.append(Lang.get("messages.new-notifications",{count:f},"en")),e.loadTemplate(base_url+"/templates/Notifications/notificationsList.html",i,{append:!0})}function markNotificationsAsSeen(a){var b=$(".notification").children(".active").toArray();return b.forEach(function(a){var b=$(a).data("noti-id");$.ajax({type:"POST",url:api_address+"Notifications("+b+")/action.Read",success:function(b){$(a).removeClass("active")},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}),$(".notifications-count-badge").empty(),$(".notifications-count-message").empty().append(Lang.get("messages.new-notifications",{count:0})),!1}function showNotification(a){var b=$("#defaultModal"),c=$(a.target).closest("[data-noti-id]"),d=c.data("noti-id");$.ajax({type:"GET",url:api_address+"Notifications("+d+")",success:function(a){c.hasClass("active")&&setNotificationAsSeen(d),b.find(".modal-title").empty().append(a.Title),b.find(".modal-body").addClass("spinner"),b.find(".modal-body").loadTemplate(base_url+"/templates/Notifications/showNotification.html",{link:linkToItem(a.Model,a.ModelId,!0),model:a.Model,modelId:a.ModelId,content:a.Content,notification_id:a.Id},{success:function(){"TaskList"!=a.Model?($.when(getCompanyName(a.Model,a.ModelId)).then(function(a){a&&$(".notificationName").append(" - "+(a.value||a))}),b.find(".modal-body").removeClass("spinner")):$.get(api_address+"TaskLists("+a.ModelId+")").success(function(c){$(".notificationName").text(" - "+c.Title),$(".notification-content").html(c.Description+"<br>"+a.Content),b.find(".modal-body").removeClass("spinner")})}}),b.modal("show")},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function setNotificationAsSeen(a){var b=$(".notifications").find("[data-noti-id='"+a+"']");$.ajax({type:"POST",url:api_address+"Notifications("+a+")/action.Read",success:function(a){b.removeClass("active"),updateNotificationsCount()},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function setNotificationAsNotSeen(a){var b=$(".notifications").find("[data-noti-id='"+a+"']");$.ajax({type:"POST",url:api_address+"Notifications("+a+")/action.UnRead",success:function(a){b.addClass("active"),updateNotificationsCount()},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function linkToItem(a,b,c){var g={Contract:"contracts",Lead:"leads",Invoice:"invoices",Order:"orders",Draft:"drafts",Salary:"salaries",TaskList:"tasks",ClientAlias:"clientAlias",Client:"clients",OrderField:"order-fields",User:"users"};return"undefined"==typeof a?"":"undefined"==typeof b?"undefined"!=typeof c?base_url+"/"+g[a]:'<a class="btn btn-'+g[a]+base_url+'" href="/">'+g[a]+a+"</a>":"undefined"!=typeof c?base_url+"/"+g[a]+"/show/"+b:'<a class="btn btn-'+g[a]+'" href="'+base_url+"/"+g[a]+"/show/"+b+'">'+a+" : "+b+"</a>"}function infoLink(a,b){return $.when($.get(api_address+"Leads("))}function updateNotificationsCount(){var a=$(".notification").children(".active").toArray();a.length>0?$(".notifications-count-badge").empty().append(a.length):$(".notifications-count-badge").empty(),$(".notifications-count-message").empty().append(Lang.get("messages.new-notifications",{count:a.length}))}function getItemFiles(){var a=$("#Model").val(),b=$("#ModelId").val();return"undefined"!=typeof a&&"undefined"!=typeof b&&void $.ajax({type:"GET",url:api_address+"FileStorages?$filter=Model eq '"+a+"' and ModelId eq "+b+"&$expand=Author($select=UserName,FullName)",success:function(a){renderFiles(a)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function renderFiles(a){a=a.value;var b=$("#item-files").find("tbody"),c=[];a.forEach(function(a){var b=new Date(a.Created);c.push({FileId:a.Id,Created:b.toDateTime(),PreviewLabel:Lang.get("labels.preview"),Name:a.Name,FullName:null==a.Author?"":a.Author.FullName,UserName:null==a.Author?"":a.Author.UserName,DownloadLabel:Lang.get("labels.download"),DeleteLabel:Lang.get("labels.delete")})}),b.loadTemplate(base_url+"/templates/uploadedFile.html",c,{prepend:!0})}function downloadFile(a){var b=$(a.target).closest("tr").data("file-id");return window.open(base_url+"/files/download/"+b,"myWindow","width=500,height=500,scrollbars=yes").focus(),!1}function previewFile(a){var b=$(a.target).closest("tr").data("file-id");return window.open(base_url+"/files/preview/"+b,"myWindow","width=500,height=500,scrollbars=yes").focus(),!1}function allowedTimes(){var b,c,a=[];for(b=7;b<18;b++)for(c=0;c<4;c++)a.push(b+":"+(0===c?"00":15*c));return a}function initializeAppointments(){openCalendarIFrame($("#user-UserName").val()),$("#userSearch_appointments").autocomplete({source:function(a,b){var c=a.term;$.get(api_address+"Users?$filter=indexof(tolower(FullName), '"+c+"') ge 0 or indexof(tolower(UserName), '"+c+"') ge 0 and Active eq true&$select=FullName,UserName,Id",{},function(a){b($.map(a.value,function(a){return{id:a.Id,label:a.FullName+" | "+a.UserName,value:a.UserName}}))})},minLength:2,select:function(a,b){$("input[name=User_Id]").val(b.item.id),addAttendee(b.item.value+"@greenclickmedia.dk"),openCalendarIFrame(b.item.value)}}),$("#appointment-Start").datetimepicker({timeFormat:"HH:mm",dateFormat:"yy-mm-dd",minDate:new Date,minTime:"7:00",maxTime:"18:00",allowTimes:allowedTimes()}),$("#createAppointment").on("submit",function(a){var b=$(this),c=b.find(":submit");a.preventDefault();var d=$(this).serializeJSON(),e=b.find(".token:not(.invalid)");e.length>0&&(d.Attendees=$.map(e,function(a){return{EMail:$(a).data("value")}})),d.NotifyAttendees=!!d.NotifyAttendees;var f=!!d.CreateOnGoogleCalendar;return delete d.CreateOnGoogleCalendar,""==d.User_Id?(new PNotify({title:Lang.get("labels.error"),text:Lang.get("labels.select-user"),type:"error"}),c.prop("disabled",!1),!1):inRole("Meet Booking")&&d.User_Id==getUserId()&&"HealthCheck"==d.EventType&&inRoleNeutral("Meet Booking")?(new PNotify({title:Lang.get("labels.error"),text:"You can not book healthcheck for yourself.",type:"error"}),c.prop("disabled",!1),!1):(d.Start=new Date(d.Start),d.Model=getModel(),d.ModelId=getModelId(),d.Source={Url:linkToItem(d.Model,d.ModelId,!0)},void $.ajax({url:api_address+"CalendarEvents",type:"POST",data:JSON.stringify(d),success:function(a){f?"Lead"==d.Model?$.ajax({url:api_address+"Leads("+d.ModelId+")/Book",type:"POST",data:JSON.stringify({Calendar_Id:a.Id}),success:function(a){new PNotify({title:Lang.get("labels.success"),text:Lang.get("labels.appointment-created"),type:"success"}),b[0].reset(),c.prop("disabled",!1)},error:function(a){c.prop("disabled",!1)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}}):$.ajax({url:api_address+"CalendarEvents("+a.Id+")/CreateOnGoogle",type:"GET",success:function(a){new PNotify({title:Lang.get("labels.success"),text:Lang.get("labels.appointment-created"),type:"success"}),b[0].reset(),c.prop("disabled",!1)},error:function(a){c.prop("disabled",!1)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}}):("Lead"==d.Model&&$.ajax({url:api_address+"Leads("+d.ModelId+")/Book",type:"POST",data:JSON.stringify({Calendar_Id:a.Id}),success:function(a){new PNotify({title:Lang.get("labels.success"),text:Lang.get("labels.appointment-created"),type:"success"}),b[0].reset(),c.prop("disabled",!1)},error:function(a){c.prop("disabled",!1)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}}),new PNotify({title:Lang.get("labels.success"),text:Lang.get("labels.appointment-created"),type:"success"}),b[0].reset(),c.prop("disabled",!1))},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}}))})}function updateAppointment(a){var b=getDefaultModal(),c=b.find(".modal-body");c.addClass("spinner"),c.loadTemplate(base_url+"/templates/appointments/appointmentUpdate.html",{CalendarEvent_Id:a},{success:function(){"CalendarEvent"!=getModel()?initializeAppointmentsTimeline(a):getModelId()||initializeAppointmentsTimeline(a);var b=$(".updateAppointmentActivities"),d=$(".moveAppointment"),e=$("#appointment-time");b.on("change",function(a){var c=$(a.target),f=c.prop("checked"),g=c.prop("name"),h=$("#commentGroup");b.prop("checked",!1),c.prop("checked",f),(f||"NoAnswer"==g)&&"NoAnswer"!=g?(d.prop("disabled",!0),d.prop("checked",!1),e.prop("disabled",!0).val("")):d.prop("disabled",!1),f?h.removeClass("hidden"):h.addClass("hidden")}),d.on("change",function(b){var c=$(b.target),d=c.prop("checked");d?(e.prop("disabled",!1),$.get(api_address+"CalendarEvents("+a+")").success(function(a){var b=moment(),c=moment(a.Start).hour(),d=moment(a.Start).minute(),f=moment(b).hour(c).minute(d);f=5==moment(b).day()?moment(f).add(3,"days"):moment(f).add(1,"days");var g=moment(f).add(30,"minutes");e.daterangepicker({startDate:f,endDate:g,parentEl:"#defaultModal",minDate:moment(),timePicker:!0,timePicker24Hour:!0,locale:{format:"YYYY-MM-DD H:mm"}})})):e.prop("disabled",!0).val("")}),e.val(""),c.removeClass("spinner")}})}function initializeAppointmentsTimeline(a){var b=$(".timelineUpdateAppointment");$.get(api_address+"CalendarEvents("+a+")/Activity?$expand=User($select=FullName),Comment($select=Id,Message)&$orderby=Created+desc").success(function(a){var c=!1,d=$.map(a.value,function(a){var b="",d="",e="";switch(a.ActivityType){case"Cancel":b="cancelled the appointment",d="fa-times",e="activityIndianred",c=!0;break;case"Completed":b="completed the appointment",d="fa-check",e="activityGreen",c=!0;break;case"Move":b="moved the appointment",d="fa-calendar-o",e="activityDodgerblue";break;case"NoAnswer":b="did not get an answer",d="fa-frown-o",e="activityGrey"}if(a.Comment)var f='"'+a.Comment.Message+'"';else f="";var g={Type:a.ActivityType,Icon:d+" "+e,Message:b,Created:a.Created,User:a.User.FullName,Comment:f};return g});c&&$("#appointmentUpdateForm").find(":submit").prop("disabled",!0).val("Appointment was cancelled or completed"),b.loadTemplate(base_url+"/templates/appointments/timeline.html",d,{success:function(){setTimeLineBorders()}})})}function setTimeLineBorders(){var a=$(".timelineItem").toArray();$.each(a,function(a,b){var c=$(b).find(".col-xs-12").height()-17;$(b).find(".borderDiv").css("height",c)})}function sortTimeline(){$(".accordion-title").remove(),$(".accordion-group .accordion-item").unwrap(),$(".accordion-item .collapse").unwrap(),$(".collapse .accordion-body").unwrap(),$(".accordion-body .timeline-item").unwrap();var b,c,a=$("#timelineSortingChange").val();"asc"==a?(b=1,c=-1):(b=-1,c=1);var d=$(".panel-timeline");d.find(".timelineItem").sort(function(a,d){var e=new Date(a.dataset.date),f=new Date(d.dataset.date);return f<e?b:c}).appendTo(d),splitTimelineIntoMonths()}function getDefaultModal(a){var b=$("#defaultModal").modal();return b.find(".modal-title").empty(),b.find(".modal-body").empty(),b.find(".modal-footer").empty(),a?b.find(".modal-content").css("width",a+"%"):b.find(".modal-content").css("width",""),b}function closeDefaultModal(){$("#defaultModal").modal("hide")}function taskCountBadge(){var a=$("#user-Id").val(),b="(AssignedTo_Id eq '"+a+"' and ParentTaskListId eq null) or (ParentTaskListId ne null and AssignedTo_Id eq '"+a+"' and Parent/AssignedTo_Id ne '"+a+"' and Value eq false)";$.ajax({type:"GET",url:api_address+"TaskLists/$count?$filter=Value eq false and "+b,success:function(a){a>0&&$(".taskCount").text(a)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function itemTaskCountBadge(a,b){$.ajax({type:"GET",url:api_address+"TaskLists/$count?$filter=Value eq false and ModelId eq "+b+" and Model eq '"+a+"' and ParentTaskListId eq null",success:function(a){a>0&&$(".itemTaskCount").text(a)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function setAliasId(a,b,c){return document.getElementById("name").innerHTML=b,document.getElementById("ClientAlias_Id").value=a,""!=c?document.getElementById("Domain").value=c:null,!1}function unsetAlias(){document.getElementById("name").innerHTML="",document.getElementById("ClientAlias_Id").value="",document.getElementById("searchInput").value=""}function groupFormFields(a){var b={};for(var c in a){var d=c.split("-");b.hasOwnProperty(d[0])?""!=a[c]&&"undefined"!=typeof d[1]&&(b[d[0]][d[1]]=a[c]):(b[d[0]]={},""!=a[c]&&"undefined"!=typeof d[1]&&(b[d[0]][d[1]]=a[c]))}return b}function getModel(){return $("#Model").val()}function getModelId(){return $("#ModelId").val()}function clearErrors(){$(".has-error").removeClass("has-error")}function getUserId(){return $("#user-Id").val()}function getUserName(){return $("#user-UserName").val()}function getUserLocalNumber(){return $("#user-LocalNumber").val()}function getSellerPeriod(){}function addEventAttendee(a){a.preventDefault();var b=$("#event-addAttendee");if(""!=b.val()&&validateEmail(b.val().trim())){var c=b.val(),d=$("input[name='attendees[email]']").map(function(){return $(this).val()}).get();if(isInArray(c,d))return new PNotify({title:Lang.get("labels.error"),text:Lang.get("labels.already-attendee"),type:"error"}),!1;$(".attendeesPlaceholder").loadTemplate(base_url+"/templates/calendar/calendarAttendee.html",{AttendeeEmail:c},{append:!0,success:function(){$("#event-addAttendee").val("")}})}else b.closest(".form-group").css("color","red").animate({color:"black"},1e3)}function checkAdWordsLink(a){return $.post(base_url+"/app/check-adwords-link",{adwordsId:a.trim()})}function cancelInvitation(a){return $.post(base_url+"/app/cancel-invitation",{adwordsId:a.trim()})}function sendInvitation(a){return $.post(base_url+"/app/send-invitation",a)}function changeAdwordsLinkStatus(a){var b=$(".adwordsIdOptions");switch(a){case"pending":b.loadTemplate(base_url+"/templates/awords/pendingInvitation.html",{PendingTitle:Lang.get("messages.pending-invitation"),CancelInvitationTitle:Lang.get("messages.cancel-invitation")});break;case"not-linked":b.loadTemplate(base_url+"/templates/awords/notLinked.html",{SendInvitationTitle:Lang.get("messages.send-invitation"),NotLinkedTitle:Lang.get("messages.not-linked")});break;case"linked":b.loadTemplate(base_url+"/templates/awords/linked.html",{LinkedTitle:Lang.get("messages.account-is-linked")})}}function findStartupMeeting(){$.get(api_address+"CalendarEvents?$filter=Model eq 'Contract' and ModelId eq "+getModelId()+" and EventType eq 'StartUpMeeting' and Start gt "+getIsoDate(moment().startOf("day"))+"&$expand=User($select=FullName,Id)").success(function(a){var b=$(".startupMeeting");0==a.value.length?(b.prepend("<button class='makeStartupMeeting'>"+Lang.get("labels.schedule-startup-meeting")+"</button>"),openCalendarIFrame(getUserName(),b.find(".startupMeetingCalendar"))):b.loadTemplate(base_url+"/templates/calendar/eventsTable.html",{},{success:function(){var b=$(".eventsTableBody");b.loadTemplate(base_url+"/templates/calendar/eventTableRow.html",{EventSummary:a.value[0].Summary,EventHtmlLink:a.value[0].HtmlLink,EventStart:a.value[0].Start,EventDescription:a.value[0].Description,EventCreator:a.value[0].User.FullName})}})})}function trueOrFalseIcon(a,b){var c=document.createElement("i");return c.classList="fa fa-"+(a?"check":"times"),b&&(b.classes&&c.classList.add(b.classes),c.title=b.title?b.title:""),c.outerHTML}function getCompanyName(a,b){return $.ajax({type:"POST",suppressErrors:!0,url:api_address+"ClientAlias/GetCompanyName",data:JSON.stringify({Model:a,ModelId:b}),beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}function findNextAppointment(a,b){}function initializeTimeVault(a,b){$.when(getTimeVault(a,b)).then(function(b){var c=$(".counselingTime");"ClientAlias"==a?0==b.Id?(c.removeClass("spinner"),c.text("No counseling  time")):(c.removeClass("spinner"),c.html(minutesToStr(b.Balance)+' <i class="fa fa-plus LogTime pseudolink" data-vault-id="'+b.Id+'" title="Log time or see transactions"></i>')):(c.html(minutesToStr(b.Balance)+' <i class="fa fa-plus LogTime pseudolink" data-vault-id="'+b.Id+'" title="Log time or see transactions"></i>'),c.removeClass("spinner"))})}function initContacts(){var a=$(".loadContactsTab"),b=$("#contactFormPlaceholder");if("ClientAlias"==getModel())var c=getModelId();else c=$("#ContactsClientAliasId").val();b.loadTemplate(base_url+"/templates/contacts/contactForm.html",{ClientAlias_Id:c},{success:function(){$("input.contact-birthdate:text").datepicker({dateFormat:"yy-mm-dd",changeYear:!0,yearRange:"-100:+0"})}});var d=canCall();contactsTable=$("#contacts-table-tab").DataTable({bPaginate:!1,bInfo:!1,bFilter:!1,iDisplayLength:"All",aaSorting:[[7,"desc"]],bProcessing:!0,bServerSide:!0,filter:"Email ne null",select:"Id,Facebook,LinkedIn,ReceiveReports",sAjaxSource:api_address+"ClientAlias("+c+")/Contact",aoColumns:[{mData:"Name"},{mData:"Phone",mRender:function(a){return createCallingLink(d,a)}},{mData:"Email",mRender:function(a){return null!==a?"<a href='mailto:"+a+"'>"+a+"</a>":""}},{mData:"JobFunction"},{mData:"Department"},{mData:"Birthdate",sType:"date",mRender:function(a){return null!=a?toDate(a):""}},{mData:"Description",sClass:"multiline"},{mData:"MainContact",mRender:function(a,b,c){var d="";return c.Facebook&&(d+="<a target='_blank' href='"+c.Facebook+"'><i class='fa fa-facebook'></i></a>&nbsp; "),c.LinkedIn&&(d+="<a target='_blank' href='"+c.LinkedIn+"'><i class='fa fa-linkedin'></i></a>&nbsp; "),c.MainContact&&(d+="<i class='fa fa-flag-o' title='This is the main contact'></i> &nbsp; "),c.ReceiveReports&&(d+="<i class='fa fa-file' title='This is the contact for reporting'></i>&nbsp; "),d+='<a href="'+base_url+"/client-contacts/edit/"+c.Id+'"><i class="fa fa-edit"></i></a> <a class="deleteContactBtn" data-contact-id="'+c.Id+'" href="#"><i class="fa fa-times"></i></a>'}}],fnServerData:fnServerOData,iODataVersion:4,bUseODataViaJSONP:!1}),a.removeClass("loadContactsTab")}function getTimeVault(a,b){return $.ajax({url:api_address+"TimeVaults/ForItem",type:"POST",data:JSON.stringify({Model:a,Item:b}),success:function(a){return a},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}void 0===jQuery.when.all&&(jQuery.when.all=function(a){var b=new jQuery.Deferred;return $.when.apply(jQuery,a).then(function(){b.resolve(Array.prototype.slice.call(arguments))},function(){b.fail(Array.prototype.slice.call(arguments))}),b}),function(a){a.fn.autogrow=function(b){return this.filter("textarea").each(function(){var c=this,d=a(c),e=d.height(),f=d.hasClass("autogrow-short")?0:parseInt(d.css("lineHeight"))||0,g=a.extend({preGrowCallback:null,postGrowCallback:null},b),h=a("<div></div>").css({position:"absolute",top:-1e4,left:-1e4,width:d.width(),fontSize:d.css("fontSize"),fontFamily:d.css("fontFamily"),fontWeight:d.css("fontWeight"),lineHeight:d.css("lineHeight"),resize:"none","word-wrap":"break-word"}).appendTo(document.body),i=function(a){var b=function(a,b){for(var c=0,d="";c<b;c++)d+=a;return d},i=c.value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n$/,"<br/>&#xa0;").replace(/\n/g,"<br/>").replace(/ {2,}/g,function(a){return b("&#xa0;",a.length-1)+" "});a&&a.data&&"keydown"===a.data.event&&13===a.keyCode&&(i+="<br />"),h.css("width",d.width()),h.html(i+(0===f?"...":""));var j=Math.max(h.height()+f,e);null!=g.preGrowCallback&&(j=g.preGrowCallback(d,h,j,e)),d.height(j),null!=g.postGrowCallback&&g.postGrowCallback(d)};d.change(i).keyup(i).keydown({event:"keydown"},i),a(window).resize(i),i()})}}(jQuery);var re_weburl=new RegExp("^(?:(?:https?|ftp)://)(?:\\S+(?::\\S*)?@)?(?:(?!(?:10|127)(?:\\.\\d{1,3}){3})(?!(?:169\\.254|192\\.168)(?:\\.\\d{1,3}){2})(?!172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2})(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,}))\\.?)(?::\\d{2,5})?(?:[/?#]\\S*)?$","i");$(document).ajaxError(function(a,b,c){if(0!=b.readyState){c.suppressErrors||new PNotify({title:Lang.get("labels.error"),text:Lang.get(b.statusText)+"<br>Developers are notified",type:"error"});var d=c.type+" "+c.url+"\r\n";b.responseJSON?(d+=b.responseJSON.error.message,"undefined"!=typeof b.responseJSON.error.innererror&&(d+=b.responseJSON.error.innererror.message)):b.statusText?d+="Response status : "+b.statusText:b.message&&(d=b.message),d+="\r\nPage :"+a.target.URL+"\r\n","POST"!=c.type&&"PATCH"!=c.type&&"PUT"!=c.type||(d+="\r\n"+c.type+" body : "+c.data),("undefined"==typeof c.saveError||c.saveError)&&saveError(d)}}),String.prototype.replaceAll=function(a,b){var c=this;return c.replace(new RegExp(a,"g"),b)},Number.prototype.format=function(a){return a="undefined"==typeof a?2:0,this.toLocaleString("da-DK",{maximumFractionDigits:a,minimumFractionDigits:a})},String.prototype.padLeft=function(a,b){return new Array(a-this.length+1).join(b||" ")+this},Date.prototype.toDateTime=function(){return[String(this.getDate()).padLeft(2,"0"),String(this.getMonth()+1).padLeft(2,"0"),String(this.getFullYear())].join("-")+" "+[String(this.getHours()).padLeft(2,"0"),String(this.getMinutes()).padLeft(2,"0")].join(":")},Date.prototype.toDate=function(){return[String(this.getDate()).padLeft(2,"0"),String(this.getMonth()+1).padLeft(2,"0"),String(this.getFullYear())].join("-")},Date.prototype.toDate=function(){return[String(this.getDate()).padLeft(2,"0"),String(this.getMonth()+1).padLeft(2,"0"),String(this.getFullYear())].join("-")},$.addTemplateFormatter({DateFormatter:function(a,b){if(null==a)return"";var c=new Date(a);return c.toDate()},DateTimeFormatter:function(a,b){if(null==a)return"";var c=new Date(a);return c.toDateTime()},UpperCaseFormatter:function(a,b){return a.toUpperCase()},LowerCaseFormatter:function(a,b){return a.toLowerCase()},SameCaseFormatter:function(a,b){return"upper"==b?a.toUpperCase():a.toLowerCase()}});var contract_team_urls={Adwords:"adwords",SEO:"seo"},contract_default_url="contracts",paymentTermsDK={Monthly:"Månedsvis",Quarterly:"Kvartalsvis",Semiannually:"Halvårlig",Annually:"Årlig",OneTime:"Engangs betaling"},localhost="http://localhost:8080/api/",liveServer="http://gcmdev.dk/api/",server="http://svn.crmtest.dk:8483/api/",api_address=liveServer;$(function(){$("body").on("click","ul.acc-menu a",function(){var a=$(this).closest("ul.acc-menu").children("li");$(this).closest("li").addClass("clicked"),$.each(a,function(b){return $(a[b]).hasClass("clicked")?($(a[b]).removeClass("clicked"),!0):(("collapse-leftbar"!==$.cookie("admin_leftbar_collapse")||$(this).parents(".acc-menu").length>1)&&$(a[b]).find("ul.acc-menu:visible").slideToggle(),void $(a[b]).removeClass("open"))}),$(this).siblings("ul.acc-menu:visible").length>0?$(this).closest("li").removeClass("open"):$(this).closest("li").addClass("open"),("collapse-leftbar"!==$.cookie("admin_leftbar_collapse")||$(this).parents(".acc-menu").length>1)&&$(this).siblings("ul.acc-menu").slideToggle({duration:200,progress:function(){checkpageheight(),$(this).closest("li").is(":last-child")&&$("#sidebar").animate({scrollTop:$("#sidebar").height()},0)},complete:function(){$("#sidebar").getNiceScroll().resize()}})});var a;$.each($("ul.acc-menu a"),function(){if(this.href==window.location)return a=this,!1});for(var b=$(a).closest("li");;)if(b.addClass("active"),b.closest("ul.acc-menu").show().closest("li").addClass("open"),b=$(b).parents("li").eq(0),$(b).parents("ul.acc-menu").length<=0)break;var c=$("li").filter(function(){return $(this).find("ul.acc-menu").length});$(c).addClass("hasChild"),"collapse-leftbar"===$.cookie("admin_leftbar_collapse")&&$("ul.acc-menu:first ul.acc-menu").css("visibility","hidden"),$("ul.acc-menu:first > li").hover(function(){"collapse-leftbar"===$.cookie("admin_leftbar_collapse")&&$(this).find("ul.acc-menu").css("visibility","")},function(){"collapse-leftbar"===$.cookie("admin_leftbar_collapse")&&$(this).find("ul.acc-menu").css("visibility","hidden")}),"collapse-leftbar"===$.cookie("admin_leftbar_collapse")&&$("body").addClass("collapse-leftbar"),$("#widgetarea").css({"max-height":$("body").height()}),$("#widgetarea").niceScroll({horizrailenabled:!1}),$("a#leftmenu-trigger").click(function(){window.innerWidth<768?$("body").toggleClass("show-leftbar"):($("body").toggleClass("collapse-leftbar"),"collapse-leftbar"===$.cookie("admin_leftbar_collapse")?($.cookie("admin_leftbar_collapse",""),$("ul.acc-menu").css("visibility","")):($.each($(".acc-menu"),function(){"none"==$(this).css("display")&&$(this).css("display","")}),$("ul.acc-menu:first ul.acc-menu").css("visibility","hidden"),$.cookie("admin_leftbar_collapse","collapse-leftbar"))),checkpageheight(),leftbarScrollShow()}),$("a#rightmenu-trigger").click(function(){$("body").toggleClass("show-rightbar"),widgetheight(),"show-rightbar"===$.cookie("admin_rightbar_show")?$.cookie("admin_rightbar_show",""):$.cookie("admin_rightbar_show","show-rightbar")}),dh=$(document).height()-40,$("#page-content").css("min-height",dh+"px"),checkpageheight()}),$(".widget-body").on("shown.bs.collapse",function(){widgetheight()}),$(window).scroll(function(){$("#widgetarea").getNiceScroll().resize(),$(".chathistory").getNiceScroll().resize(),rightbarTopPos(),leftbarTopPos()}),$(window).resize(function(){widgetheight(),rightbarRightPos(),$("#sidebar").getNiceScroll().resize()}),rightbarRightPos(),$("#back-to-top").click(function(){return $("body,html").animate({scrollTop:0},500),!1}),$("a.panel-collapse").click(function(){return $(this).children().toggleClass("fa-chevron-down fa-chevron-up"),$(this).closest(".panel-heading").next().slideToggle({duration:200}),$(this).closest(".panel-heading").toggleClass("rounded-bottom"),!1}),$("#headerbardropdown").click(function(){return $("#headerbar").css("top",0),!1}),$("#headerbardropdown").click(function(a){$("html").one("click",function(){$("#headerbar").css("top","-1000px")}),a.stopPropagation()}),$("#search>a").click(function(){$("#search").toggleClass("keep-open"),$("#search>a i").toggleClass("opacity-control")}),$("#search").click(function(a){$("html").one("click",function(){$("#search").removeClass("keep-open"),$("#search>a i").addClass("opacity-control")}),a.stopPropagation()}),$(".panel-footer").prev().css("border-radius","0");var base_url=location.origin;$(document).ready(function(){var a=$.cookie("auth");if(a||$.get(base_url+"/auth/logout",function(a){window.location.replace(base_url+"/auth/login")}),$.ajaxSetup({headers:{Authorization:"Bearer "+a,"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$("textarea.autosize").autogrow(),$("#rightmenu-trigger").length){var b=getModel(),c=getModelId();taskCountBadge(),b&&c&&itemTaskCountBadge(b,c),$("#rightmenu-trigger").click(function(){$("body").hasClass("show-rightbar")&&(myTasks(),b&&c&&itemTasks(b,c))})}var d=$("body");d.on("click",".read-all-notifications",function(a){return markNotificationsAsSeen(a),!1}),d.on("click",".expandTasks",function(a){a.preventDefault();var b=$(a.target).closest(".rightMenuTaskContainer").find(".taskCheck").val();expandSubtasks(b)}),d.on("click",".notification",function(a){return showNotification(a),!1}),d.on("click",".mark-as-not-seen",function(a){var b=$(a.target).data("notification-id");return setNotificationAsNotSeen(b),!1}),d.on("click",".deleteContactBtn",function(a){return deleteContact(a),!1}),d.on("submit","#addContactToAlias",function(a){return saveContact(a),!1}),d.on("click",".loadContactsTab",function(a){$(a.target).removeClass("loadContactsTab"),initContacts()}),$("#item-files").length>0&&getItemFiles(),d.on("click",".downloadFile",function(a){return downloadFile(a),!1}),d.on("click",".deleteFile",function(a){return deleteFile(a),!1}),$("form.dropzone").length>0&&initializeDropzone(),$(".headerNotifications").length>0&&getNotifications(),$(".createOrder").on("click",function(){return openCreateOrderModal(),!1}),d.on("click",".more-link",function(){$(this).closest(".is-more").hasClass("multiline")?$(this).closest(".is-more").removeClass("multiline"):$(this).closest(".is-more").addClass("multiline")}),$("input#userSearch_appointments").length>0&&initializeAppointments(),$("#admin").length>0&&initializeAdminMenu(),d.on("click",".updateAppointment",function(a){a.preventDefault();var b=$(a.target).data("calendarevent-id");updateAppointment(b)}),d.on("click","#addAttendeeToEvent",function(a){a.preventDefault();var b=$("#add-attendee-field");b.closest(".form-group").removeClass("has-error");var c=b.val();validateEmail(c)?addAttendee(c):b.closest(".form-group").addClass("has-error")}),d.on("click",".previewFile",function(a){return previewFile(a),!1}),d.on("click",".quickEditTask",function(a){a.preventDefault();var b=$(a.target).closest(".rightMenuTaskContainer").find(".taskCheck").val();quickEditTask(b)}),$(".seoChecklist").length>0&&initializeSeoChecklist(),d.on("submit","#quickTaskEditForm",function(a){a.preventDefault();var b=$(this).serializeJSON();updateTask(a,b)}),d.on("change",".taskCheck",function(a){return checkTask(a),!1}),$(".seeAllComments").click(function(){return $('#myTab a[href="#comments"]').tab("show"),window.location.hash="comments",!1}),$(".addCommentButton").click(function(){return $('#myTab a[href="#comments"]').tab("show"),window.location.hash="comments",$("#newCommentForm").find("textarea").focus(),
    !1}),$("#myTab a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("ul.nav-tabs > li > a").on("shown.bs.tab",function(a){var b=$(a.target).attr("href").substr(1);window.location.hash=b});var e=window.location.hash;$('#myTab a[href="'+e+'"]').tab("show"),"#draftsTab"==e?($(".loadDraftsTab").removeClass("loadDraftsTab"),loadDraftsTab()):"#orders"==e?($(".loadOrders").removeClass("loadOrders"),loadOrders()):"#contacts"==e&&($(".loadContactsTab").removeClass("loadContactsTab"),initContacts()),navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&""!==e&&setFavicon(),$("input[type=number]:not([min])").length>0&&$("input[type=number]").prop("min",0),$("#tokenfield-email").length>0&&initAttendeesInput(),d.on("click","#addItemToCheckList",function(a){a.preventDefault();var b=$("#checklistItem-Title"),c=$("#checklistItem-Description"),d=$("#checklistItem-AssignedTo_Id"),e=$(".checklistItemsList");return""==b.val()?(b.closest(".form-group").addClass("has-error"),void b.focus()):void e.loadTemplate(base_url+"/templates/tasks/checklistFormItem.html",{Title:b.val(),Description:c.val(),AssignedTo:""==d.val()?"null":d.val()},{prepend:!0,success:function(){b.val(""),c.val(""),d.val("")}})}),d.on("submit","#checkListForm",function(a){a.preventDefault();var b=$(this).serializeJSON();""==b.AssignedTo_Id&&(b.AssignedTo_Id=null),b.Children&&$.each(b.Children,function(a,c){"null"==b.Children[a].AssignedTo_Id&&(b.Children[a].AssignedTo_Id=null)}),$.ajax({url:api_address+"TaskLists",type:"POST",data:JSON.stringify(b),success:function(a){$.get(api_address+"TaskLists("+a.Id+")?$expand=Children($select=Id,Title,Description,Value)&$select=Id,Title,Description,Value").success(function(a){renderChecklistItems([a])}),closeDefaultModal()},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}),d.on("click","#addCheckList",function(){return openCheckListMenu(),!1}),d.on("click","#showCompletedCheckList",function(a){a.preventDefault(),$(".seoChecklist > .completedSeo").toggle();var b=$(this);b.toggleClass("showSeo"),b.hasClass("showSeo")?b.val("Hide completed"):b.val("Show completed")}),d.on("submit",".adminUserAssignForm",function(a){a.preventDefault();var b=$(this);adminUserAssigned(b)}),d.on("click","#addEventAttendee",function(a){addEventAttendee(a)}),$(".createEvent").click(function(){var a=getDefaultModal();a.find(".modal-title").append(Lang.get("labels.create-event")),a.find(".modal-body").loadTemplate(base_url+"/templates/calendar/addEventForm.html",{TypeLabel:Lang.get("labels.type"),SummaryLabel:Lang.get("labels.summary"),DescriptionLabel:Lang.get("labels.description"),TimeLabel:Lang.get("labels.time"),AttendeesLabel:Lang.get("labels.attendees"),CreateLabel:Lang.get("labels.create"),OptionsLabel:Lang.get("labels.options"),NotifyAttendeesLabel:Lang.get("labels.notify-attendees"),CreateOnGoogleLabel:Lang.get("labels.create-on-google")},{success:function(){initAttendeesInput(),$("#event-time").daterangepicker({parentEl:"#defaultModal",minDate:moment(),timePicker:!0,timePicker24Hour:!0,locale:{format:"YYYY-MM-DD H:mm"}});var a=$("#event-Type");$.get(base_url+"/calendar/get-event-types").success(function(b){$.each(b,function(b,c){a.append("<option value='"+b+"'>"+c+"</option>")})})}})}),d.on("submit","#createEventForm",function(a){a.preventDefault();var b=$(a.target),c=b.find(":submit");c.prop("disabled",!0);var d=$(this).serializeJSON();d.NotifyAttendees=!!d.NotifyAttendees;var e=!!d.CreateOnGoogleCalendar;delete d.CreateOnGoogleCalendar,d.User_Id=getUserId();var f=d.time.split(" - ");delete d.time,d.Start=new Date(f[0]),d.End=new Date(f[1]),d.Model=d.Model||getModel()||null,d.ModelId=d.ModelId||getModelId()||null,d.Model&&d.ModelId&&(d.Source={Url:linkToItem(d.Model,d.ModelId,!0)}),$.ajax({url:api_address+"CalendarEvents",type:"POST",data:JSON.stringify(d),success:function(a){e&&$.ajax({url:api_address+"CalendarEvents("+a.Id+")/CreateOnGoogle",type:"GET",success:function(a){c.prop("disabled",!1),new PNotify({title:Lang.get("labels.success"),text:Lang.get("labels.appointment-created"),type:"success"}),new PNotify({text:Lang.get("messages.calendar-sync-delay")}),refreshCalendar()},error:function(a){c.prop("disabled",!1)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}}),closeDefaultModal()},error:function(a){c.prop("disabled",!1)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}),$("#pauseContractForm").on("submit",function(a){a.preventDefault();var b=$(this).serializeJSON();$.post(api_address+"Contracts("+getModelId()+")/action.Pause",JSON.stringify(b)).success(function(){location.reload(!0)})}),$("#resumeContractForm").on("submit",function(a){a.preventDefault();var b=$(this).serializeJSON();$.post(api_address+"Contracts("+getModelId()+")/action.Resume",JSON.stringify(b)).success(function(){location.reload(!0)})}),$(d).on("click",".cancelInvitation",function(a){var b=$(a.target);b.css("pointer-events","none");var c=$(".adwordsIdCheck").text().trim();""!=c&&$.when(cancelInvitation(c)).then(function(a){changeAdwordsLinkStatus(a)}).fail(function(a){b.css("pointer-events","")})}),d.on("click",".sendInvitation",function(a){var b=$(a.target);b.css("pointer-events","none");var c={},d=$(".adwordsIdCheck").text().trim();return""==$(".adwordsPendingLinkName").text()?(new PNotify({title:"Invalid Homepage",text:"Please update the information with a valid homepage",type:"error"}),b.css("pointer-events",""),!1):(c.website=$(".adwordsPendingLinkName").text(),c.adwordsId=d,void(""!=d&&$.when(sendInvitation(c)).then(function(a){changeAdwordsLinkStatus(a)}).fail(function(a){b.css("pointer-events","")})))});var f=$(".adwordsIdCheck"),g=f.text().trim().replaceAll(/\D/g,"");""!=g&&$.when(checkAdWordsLink(g)).then(function(a){changeAdwordsLinkStatus(a)}),d.on("click",".makeStartupMeeting",function(a){var b=getDefaultModal();b.find(".modal-title").append(Lang.get("labels.create-event")),b.find(".modal-body").loadTemplate(base_url+"/templates/calendar/addEventForm.html",{TypeLabel:Lang.get("labels.type"),EventTypes:["StartUpMeeting"],SummaryLabel:Lang.get("labels.summary"),DescriptionLabel:Lang.get("labels.description"),TimeLabel:Lang.get("labels.time"),AttendeesLabel:Lang.get("labels.attendees"),CreateLabel:Lang.get("labels.create"),OptionsLabel:Lang.get("labels.options"),NotifyAttendeesLabel:Lang.get("labels.notify-attendees"),CreateOnGoogleLabel:Lang.get("labels.create-on-google")},{success:function(){$("#event-time").daterangepicker({minDate:moment(),timePicker:!0,timePicker24Hour:!0,locale:{format:"YYYY-MM-DD H:mm"}})}})}),d.on("click",".more-link",function(){$(this).closest(".is-more").toggleClass("multiline")}),d.on("click","#createGoal",function(){var a=getDefaultModal();a.find(".modal-title").empty().append(Lang.get("labels.create-goal")),a.find(".modal-body").empty().loadTemplate(base_url+"/templates/sellerGoals/createGoalForm.html",{SelectUserLabel:Lang.get("labels.select-seller"),GoalPeriodLabel:Lang.get("labels.goal-period"),Years:getYearsSelect(),NewSalesCountGoalLabel:Lang.get("labels.new-sales-count"),NewSalesGoalLabel:Lang.get("labels.new-sales-goal"),UpSalesCountGoalLabel:Lang.get("labels.upsale-count"),UpSalesGoalLabel:Lang.get("labels.upsale-goal"),ReSalesCountGoalLabel:Lang.get("labels.resale-count"),ReSalesGoalLabel:Lang.get("labels.resale-goal"),CallsGoalLabel:Lang.get("labels.calls-goal"),HealthChecksGoalLabel:Lang.get("labels.healthchecks-goal"),CreateLabel:Lang.get("labels.create")},{success:function(){$.get(base_url+"/users/listByRoles",{roles:["Sales"]}).success(function(a){var b=$("#goal-User_Id"),c=JSON.parse(a);for(var d in c)c.hasOwnProperty(d)&&b.append($("<option></option>").attr("value",d).text(c[d]));var e=$("#goal-Month"),f=moment.months(),g=1;f.forEach(function(a){e.append($("<option></option>").attr("value",g).text(a)),g++})})}})}),d.on("click",".CopySellerGoal",function(a){var b=$(a.target).data("goal-id");$.get(api_address+"SellerGoals("+b+")?$expand=User($select=Id)").success(function(a){var c=getDefaultModal();c.find(".modal-title").empty().append(Lang.get("labels.copy-goal")),c.find(".modal-body").empty().loadTemplate(base_url+"/templates/sellerGoals/copyGoalForm.html",{GoalId:b,SelectUserLabel:Lang.get("labels.select-seller"),GoalPeriodLabel:Lang.get("labels.goal-period"),Years:getYearsSelect(),NewSalesCountGoalLabel:Lang.get("labels.new-sales-count"),NewSalesCountGoal:a.NewSalesCountGoal,NewSalesGoalLabel:Lang.get("labels.new-sales-goal"),NewSalesGoal:a.NewSalesGoal,UpSalesCountGoalLabel:Lang.get("labels.upsale-count"),UpSalesCountGoal:a.UpSalesCountGoal,UpSalesGoalLabel:Lang.get("labels.upsale-goal"),UpSalesGoal:a.UpSalesGoal,ReSalesCountGoalLabel:Lang.get("labels.resale-count"),ReSalesCountGoal:a.ReSalesCountGoal,ReSalesGoalLabel:Lang.get("labels.resale-goal"),ReSalesGoal:a.ReSalesGoal,CallsGoalLabel:Lang.get("labels.calls-goal"),CallsGoal:a.CallsGoal,HealthChecksGoalLabel:Lang.get("labels.healthchecks-goal"),HealthChecksGoal:a.HealthChecksGoal,CreateLabel:Lang.get("labels.copy")},{success:function(){$.get(base_url+"/users/listByRoles",{roles:["Sales"]}).success(function(b){var c=$("#goal-User_Id"),d=JSON.parse(b);for(var e in d)d.hasOwnProperty(e)&&c.append($("<option></option>").attr("value",e).text(d[e]));c.val(a.User_Id)});var b=$("#goal-Month"),c=moment.months(),d=1;c.forEach(function(a){b.append($("<option></option>").attr("value",d).text(a)),d++}),b.val(a.Month),$("#goal-Year").val(a.Year)}})})}),$("#main-search").autocomplete({source:function(a,b){var c=a.term;$.get(api_address+"ClientAlias?$filter=indexof(tolower(Name), '"+encodeURIComponent(c.replaceAll("'","''"))+"') ge 0 or indexof(tolower(Homepage), '"+encodeURIComponent(c.replaceAll("'","''"))+"') ge 0",{},function(a){b($.map(a.value,function(a){return{id:a.Id,label:a.Name+"  "+(null!=a.Homepage?a.Homepage:"*missing homepage*"),value:a.Name,homepage:a.Homepage}}))})},minLength:2,select:function(a,b){window.location=base_url+"/clientAlias/show/"+b.item.id}}),d.on("click",".addOptimizeRule",function(a){var b=$(this).data("product-id"),c=getDefaultModal();c.find(".modal-title").empty().append(Lang.get("labels.create-optimize-rule")),c.find(".modal-body").loadTemplate(base_url+"/templates/optimizeRules/createOptimizeRuleForm.html",{ProductId:b,CreateLabel:Lang.get("labels.save"),OptimizeIntervalLabel:Lang.get("labels.optimize-interval"),Sizes:sizes,SizeLabel:Lang.get("labels.size"),TaskTemplateLabel:Lang.get("labels.task-template")},{success:function(){var a=$("#optimizeRule-TaskList_Id");for(var b in taskTemplates)a.append($("<option></option>").attr("value",b).text(taskTemplates[b]))}})}),d.on("click",".editOptimizeRule",function(a){var b=$(this).data("optimize-rule-id");$.get(api_address+"OptimizeRules("+b+")").success(function(a){var c=getDefaultModal();c.find(".modal-title").empty().append(Lang.get("labels.edit-optimize-rule")),c.find(".modal-body").loadTemplate(base_url+"/templates/optimizeRules/editOptimizeRuleForm.html",{OptimizeRuleId:b,SaveLabel:Lang.get("labels.save"),OptimizeIntervalLabel:Lang.get("labels.optimize-interval"),TaskTemplateLabel:Lang.get("labels.task-template"),OptimizeInterval:a.OptimizeInterval},{success:function(){var b=$("#optimizeRule-TaskList_Id");for(var c in taskTemplates)b.append($("<option></option>").attr("value",c).text(taskTemplates[c]));b.val(a.TaskList_Id)}})})}),""!=canCall()&&d.on("click",".flexfoneCallOut",function(a){a.preventDefault();var b=$(a.target);b.css("pointer-events","none");var c=$(a.target).text(),d=formatPhoneNumber(c);""!=d&&$.ajax({url:api_address+"CallLogs/InitiateCall",type:"POST",data:JSON.stringify({TargetNumber:d}),success:function(){new PNotify({title:Lang.get("messages.calling-through-phone")}),setTimeout(function(){b.css("pointer-events","")},3e3)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}),d.on("click",".quickClientComment",function(a){a.preventDefault();var b=$(a.target).data("client-id"),c=getModel()||"ClientAlias",d=getDefaultModal();d.find(".modal-title").append(Lang.get("labels.quick-comment")),d.find(".modal-body").loadTemplate(base_url+"/templates/comments/quickCommentForm.html",{Model:c,ModelId:b,SaveLabel:Lang.get("labels.save-comment"),EnterMessageLabel:Lang.get("labels.enter-comment")})}),d.on("submit","#quickCommentForm",function(a){a.preventDefault();var b=$(this).serializeJSON();$.ajax({url:api_address+"Comments",type:"POST",data:JSON.stringify(b),success:function(){closeDefaultModal(),new PNotify({title:Lang.get("messages.comment-was-saved"),type:"success"})},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}),$(".refreshCalendar").click(function(a){$(a.target).css("pointer-events","none"),refreshCalendar(),setTimeout(function(){$(a.target).css("pointer-events","")},2e3)}),$(".printPage").click(function(a){a.preventDefault(),window.print()}),$(".sendBugReport").on("click",function(a){var b=getDefaultModal();b.find(".modal-body").append('<iframe src="https://docs.google.com/a/greenclickmedia.dk/forms/d/1AAFy10pfnQcEv_-1b_aii191DHWRIinmqZ17GG8OwU8/viewform?embedded=true" width="500" height="500" frameborder="0" marginheight="0" marginwidth="0">Loading...</iframe>')}),$(".next-appointment").length>0&&findNextAppointment(getModel(),getModelId()),d.on("mouseenter",".progress-title",function(a){var b=$(a.target).closest(".progress-title");b.data("task-model-id")&&b.data("task-model")&&$.when(getCompanyName(b.data("task-model"),b.data("task-model-id"))).then(function(a){a&&b.prop("title","Company name: "+a.value+" \n "+b.prop("title")),b.data("task-model",null)})}),d.on("click",".loadDraftsTab",function(a){$(a.target).removeClass("loadDraftsTab"),loadDraftsTab(a)}),d.on("click",".loadOrders",function(a){$(a.target).removeClass("loadOrders"),loadOrders(a)}),$("#saveAdwordsId").on("submit",function(a){a.preventDefault();var b=$(this),c=b.find(":submit");c.prop("disabled",!0);var d=b.serializeJSON(),e=d.clientAliasId;delete d.clientAliasId,$.ajax({url:api_address+"ClientAlias("+e+")",type:"PATCH",data:JSON.stringify(d),success:function(a){new PNotify({title:"AdwordsId saved. Refreshing..."}),location.reload(!0)},error:function(a){c.prop("disabled",!1)},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}),$("body").on("click",".quickSaveContractId",function(a){var c=($(a.target),$(this).data("pk"));a.preventDefault(),$(a.target).editable({validate:function(a){var b=new RegExp(/\b\d{3}[-]?\d{3}[-]?\d{4}\b/g);if(!b.test(a))return"########## or ###-###-####"},ajaxOptions:{type:"patch",dataType:"application/json",beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}},params:function(a){var b={};return b.AdwordsId=a.value,JSON.stringify(b)},url:api_address+"Contracts("+c+")",success:function(){location.reload(!0)}}).removeClass("quickSaveContractId"),setTimeout(function(){$(a.target).click()},200)}),d.on("click",".quickEditSubTask",function(a){var b=$(a.target).closest("td").find(".taskCheck").val();quickEditTask(b,!0)}),d.on("change","#setForCurrentItem",function(a){var b=getModel(),c=getModelId(),d=document.getElementById("task-Model"),e=document.getElementById("task-ModelId"),f=$(a.target).prop("checked");if(f){if(!c)return new PNotify({title:"Error",text:"You are not at any item",type:"error"}),document.getElementById("setForCurrentItem").checked=!1,!1;d.value=b,e.value=c}else d.value="",e.value=""}),d.on("click",".quickUpdateAppointment",function(a){var b=$(a.target);b.css("pointer-events","none");var c=b.data("appointment-id");$.get(api_address+"CalendarEvents("+c+")?$expand=Activity($expand=User($select=FullName))").success(function(){})}),d.on("submit","#appointmentUpdateForm",function(a){a.preventDefault();var b=$(a.target),c=b.find(":submit"),d=$(this).serializeJSON(),e=$("#appointment-comment"),f=d.CalendarEvent_Id;delete d.CalendarEvent_Id;var g=!1,h=null,i=d.moveAppointment;if(d.Cancel?(g=!0,h="Cancel"):d.NoAnswer?(g=!0,h="NoAnswer"):d.Completed&&(g=!0,h="Completed"),g){c.prop("disabled",!0);var j={};j.Type=h,j.Comment=d.Comment,e.is(":visible")&&e.val().length<15?$.get(api_address+"CalendarEvents("+f+")?$select=EventType").success(function(a){return"HealthCheck"==a.EventType?(new PNotify({title:"Error",text:"Please write a comment of at least 15 characters",type:"error"}),e.focus(),c.prop("disabled",!1),!1):void $.ajax({url:api_address+"CalendarEvents("+f+")/AddActivity",type:"POST",data:JSON.stringify(j),success:function(a){!i&&"CalendarEvent"==getModel()&&getModelId()?location.reload(!0):"CalendarEvent"!=getModel()||getModelId()||(closeDefaultModal(),appointmentsListTable.draw())},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}):$.ajax({url:api_address+"CalendarEvents("+f+")/AddActivity",type:"POST",data:JSON.stringify(j),success:function(a){!i&&"CalendarEvent"==getModel()&&getModelId()?location.reload(!0):"CalendarEvent"!=getModel()||getModelId()||(closeDefaultModal(),appointmentsListTable.draw())},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}if(i){if(c.prop("disabled",!0),!$("#appointment-time").val())return new PNotify({title:"Error",text:"Please pick a new date",type:"error"}),$("#appointment-time").focus(),!1;var k={},l=d.time.split(" - ");delete d.time,k.Start=new Date(l[0]),k.End=new Date(l[1]),$.ajax({url:api_address+"CalendarEvents("+f+")",type:"Patch",data:JSON.stringify(k),success:function(a){closeDefaultModal(),"CalendarEvent"==getModel()&&(getModelId()?location.reload(!0):appointmentsListTable.draw())},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}}),d.on("click","#saveTask",function(){if(""!=$("#task-ModelId").val()&&""==$("#task-Model").val())return new PNotify({title:"Please select item type",type:"error"}),!1}),d.on("mouseout","#task-ModelId",function(){$("#task-ModelId").val()&&["ClientAlias","Contract","Invoice","Order","Order","Lead"].indexOf($("#task-Model").val())!==-1?$.when(getCompanyName($("#task-Model").val(),$("#task-ModelId").val())).then(function(a){var b="View";"Undefined"!=a.value&&(b=a.value),$("#clientName").html(""),$("#clientName").append(b)}):$("#clientName").html("")}),d.on("click",".LogTime",function(a){var b=$(a.target).data("vault-id");openTimeVaultMenu(b)}),d.on("submit","#logTimeForm",function(a){a.preventDefault();var b=$(a.target),c=b.serializeJSON();c.Model=getModel(),c.Item=getModelId(),c.Minutes=c.Minutes*("ClientAlias"==c.Model?-1:1),$.ajax({url:api_address+"TimeVaults/Withdraw",type:"POST",data:JSON.stringify(c),success:function(){initializeTimeVault(c.Model,c.Item),closeDefaultModal()},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}),$(".timelineLoad").on("click",function(){setTimeLineBorders()}),$("#timeline").length>0&&(sortTimeline(),setTimeLineBorders(),$("#timelineSortingChange").on("change",function(){sortTimeline()})),$("#includeTimeline").on("submit",function(a){a.preventDefault();var b=$(a.target),d=(b.find(":submit"),b.serializeJSON()),e=[];d["timeline-payments"]&&e.push(timelinePayments()),d["timeline-comments"]&&e.push(timelineComments()),d["timeline-timelogs"]&&e.push(timelineTimeLogs()),d["timeline-tasks"]&&e.push(timelineTasks()),e.length>0&&$.when.all(e).then(function(a){var b=$(".panel-timeline");b.addClass("spinner"),Array.isArray(a[1])||(a=[a[0]]);var c=[];$.each(a,function(a,b){if(Array.isArray(b))var d=b[0]["@odata.context"].split("#")[1].split("(")[0],e=b[0].value;else{var d=b["@odata.context"].split("#")[1].split("(")[0];e=b.value}if(e.length>0)switch(d){case"Invoices":$("#timeline-payments").prop("disabled",!0).prop("checked",!1),$.each(e,function(a,b){var d={Created:b.Created,ColorStyle:"color:yellow",FullName:b.User.FullName,Message:" sent out Invoice .: "+b.InvoiceNumber,Class:"fa fa-barcode fa-stack-1x"};if(c.push(d),null!=b.Payed){var e=d={Created:b.Payed,ColorStyle:"color:green",Message:"Invoice "+b.InvoiceNumber+" was paid",Class:"fa fa-money fa-stack-1x"};c.push(e)}});break;case"Comments":$("#timeline-comments").prop("disabled",!0).prop("checked",!1),$.each(e,function(a,b){var d={Created:b.Created,ColorStyle:"color:yellow",FullName:b.User.FullName,Message:" commented ",Comment:b.Message,Class:"fa fa-comment fa-stack-1x"};c.push(d)});break;case"TimeTransactions":$("#timeline-timelogs").prop("disabled",!0).prop("checked",!1),$.each(e,function(a,b){var d={Created:b.Created,ColorStyle:"color:orange",FullName:b.User.FullName,Message:" logged time  : "+minutesToStr(b.Amount),Comment:b.Comment?b.Comment.Message:"",Class:"fa fa-calendar-o fa-stack-1x"};c.push(d)});break;case"TaskLists":$("#timeline-tasks").prop("disabled",!0).prop("checked",!1),$.each(e,function(a,b){var d={Created:null!=b.EndTime?b.EndTime:b.Created,ColorStyle:"color:orange",FullName:null!=b.CompletedBy?b.CompletedBy.FullName:"Unknown user",Message:" completed task : "+b.Title,Comment:b.Description,Class:"fa fa-list-ul fa-stack-1x"};c.push(d)})}}),c.length>0?$(".panel-timeline").loadTemplate(base_url+"/templates/timeline/timelineItem.html",c,{prepend:!0,overwriteCache:!0,success:function(){sortTimeline()}}):b.removeClass("spinner")})}),$.cookie("timeReg")?(timeRegStatus=$.cookie("timeReg"),loadTimeRegButtons(timeRegStatus)):$.when(getTimeregStatus()).then(function(a){var b=a.Status;setTimeRegCookie(b),timeRegStatus=$.cookie("timeReg"),loadTimeRegButtons(timeRegStatus)}),d.on("click",".accordion-title",function(a){a.preventDefault();var b=$(a.target);$(b).closest(".accordion-title").hasClass("collapsed")&&setTimeout(function(){setTimeLineBorders()},1)}),d.on("click","#expandAllItems",function(a){a.preventDefault();var b=$(".accordion-item"),c=$(this);c.toggleClass("expandAll"),c.hasClass("expandAll")?(c.val("Hide all items"),$.each(b,function(a,b){$(b).find(".accordion-title").removeClass("collapsed").attr("aria-expanded","true"),$(b).find(".collapse").addClass("in").attr("aria-expanded","true").css("height","auto")})):(c.val("Expand all items"),$.each(b,function(a,b){$(b).find(".accordion-title").addClass("collapsed").attr("aria-expanded","false"),$(b).find(".collapse").removeClass("in").attr("aria-expanded","false").css("height","0px")})),setTimeLineBorders()}),d.on("change","#event-Type",function(a){console.log(lead);var b=$(this).val(),c=$("#appointment-Description");if(c.text(""),"HealthCheck"==b){var d=lead.ContactPerson||$("#quickUpdateLead table tr td.leadContactPerson").text().trim(),e=lead.ContactEmail||$("#quickUpdateLead table tr td.leadContactEmail").text().trim(),f=lead.AdwordsId||$("#quickUpdateLead table tr td.adwordsIdCheck").text().trim(),g=lead.Phone||$("#quickUpdateLead table tr td.leadPhone").text().trim(),h="";""!=d&&(h+="Kontaktperson: "+d),""!=e&&(h+="\nEmail: "+e),""!=f&&(h+="\nAdWords ID: "+f),""!=g&&(h+="\nTelefon: "+g),h+="\n---\n\n",c.text(h)}c.focus()}),$(".contractFieldValuesPlaceholder").length>0&&initContractFieldValues()}),$(".refreshTasks").click(function(a){$(a.target).css("pointer-events","none"),dashboardTasks(),setTimeout(function(){$(a.target).css("pointer-events","")},2e3)}),$("#openTaskCreation").click(function(){return"none"==$("#taskCreate").css("display")?($("#taskCreate").show(),$("input[name=quickAddTask]").focus()):$("#taskCreate").hide(),!1}),$("#closeIFrame").click(function(){return $("#iframe").hide(),!1}),$("body").on("click","button#editTaskIFrame",function(){showIFrame($(this).attr("value"))}),$("#quickAddTaskForm").on("submit",function(a){a.preventDefault();var b=$(this);b.find("button[type=submit]").attr("disabled",!0);var c=b.serializeJSON();c.ForItem&&getModel()&&getModelId()&&(c.Model=getModel(),c.Item=getModelId(),delete c.ForItem),c.NotifyCreator=!0,$.ajax({url:api_address+"TaskLists/action.NewTask",type:"post",data:JSON.stringify(c),success:function(a){$("body").hasClass("show-rightbar")&&myTasks(),taskCountBadge(),b.find("button[type=submit]").attr("disabled",!1),b[0].reset(),(a.Model&&a.ModelId||c.ForItem)&&itemTasks(),quickEditTask(a.Id),$(".panel-tasks").length>0&&dashboardTasks()},error:function(a){b.find("button[type=submit]").attr("disabled",!1);new PNotify({title:"Error",text:"Could not save task",type:"error"})},beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")}})}),breakCounter="",$(window).resize(function(){setTimeLineBorders()});