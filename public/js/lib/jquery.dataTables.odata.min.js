function fnServerOData(sUrl,aoData,fnCallback,oSettings){var oParams={};$.each(aoData,function(i,value){oParams[value.name]=value.value});var data={$format:"json"};var bJSONP=oSettings.oInit.bUseODataViaJSONP;if(bJSONP){data.$callback="odatatable_"+(oSettings.oFeatures.bServerSide?oParams.sEcho:"load_"+Math.floor(Math.random()*1e3+1))}$.each(oSettings.aoColumns,function(i,value){var sFieldName=value.sName!==null&&value.sName!==""?value.sName:typeof value.mData==="string"?value.mData:null;if(sFieldName===null||!isNaN(Number(sFieldName))){return}if(data.$select==null){data.$select=sFieldName}else{data.$select+=","+sFieldName}});if(typeof oSettings.oInit.select!=="undefined"){data.$select+=","+oSettings.oInit.select}if(oSettings.oFeatures.bServerSide){data.$skip=oSettings._iDisplayStart;if(oSettings._iDisplayLength>-1){data.$top=oSettings._iDisplayLength}if(oSettings.oInit.iODataVersion!==null&&oSettings.oInit.iODataVersion<4){data.$inlinecount="allpages"}else{data.$count=true}var asFilters=[];var asColumnFilters=[];$.each(oSettings.aoColumns,function(i,value){var sFieldName=value.sName||value.mData||value.oData;var columnFilter=oParams["sSearch_"+i];if(typeof columnFilter!=="undefined"){if((oParams.sSearch!==null&&oParams.sSearch!==""||columnFilter!==null&&columnFilter!=="")&&value.bSearchable){switch(value.sType){case"string":case"html":if(oParams.sSearch!==null&&oParams.sSearch!==""){asFilters.push("indexof(tolower("+sFieldName+"), '"+oParams.sSearch.toLowerCase().replace(/'/g,"''")+"') gt -1")}if(columnFilter!==null&&columnFilter!==""){asColumnFilters.push("indexof(tolower("+sFieldName+"), '"+columnFilter.toLowerCase().replace(/'/g,"''")+"') gt -1")}break;case"date":case"numeric":var fnFormatValue=value.sType=="numeric"?function(val){return val}:function(val){switch(oSettings.oInit.iODataVersion){case 4:return new Date(val).toISOString();case 3:return"datetimeoffset'"+new Date(val).toISOString()+"'";case 2:return"DateTime'"+new Date(val).toISOString()+"'"}};if(columnFilter!==null&&columnFilter!==""&&columnFilter!=="~"){asRanges=columnFilter.split("~");if(asRanges[0]!==""){asColumnFilters.push("("+sFieldName+" gt "+fnFormatValue(asRanges[0])+")")}if(asRanges[1]!==""){asColumnFilters.push("("+sFieldName+" lt "+fnFormatValue(asRanges[1])+")")}}break;default:}}}});if(oSettings.oInit.filter!=undefined){if(asFilters.length>0){data.$filter=oSettings.oInit.filter;data.$filter+=" and ("+asFilters.join(" or ")+")"}else{data.$filter=oSettings.oInit.filter}}else{if(asFilters.length>0){data.$filter=asFilters.join(" or ")}}if(asColumnFilters.length>0){if(data.$filter!==undefined){data.$filter=" ( "+data.$filter+" ) and ( "+asColumnFilters.join(" and ")+" ) "}else{data.$filter=asColumnFilters.join(" and ")}}var asOrderBy=[];for(var i=0;i<oParams.iSortingCols;i++){if(oParams["mDataProp_"+oParams["iSortCol_"+i]]==null){asOrderBy.push(oSettings["aoColumns"][oParams["iSortCol_"+i]]["oData"]+" "+(oParams["sSortDir_"+i]||""))}else{asOrderBy.push(oParams["mDataProp_"+oParams["iSortCol_"+i]]+" "+(oParams["sSortDir_"+i]||"desc"))}}if(asOrderBy.length>0){data.$orderby=asOrderBy.join()}}$.ajax(jQuery.extend({},oSettings.oInit.ajax,{url:sUrl,data:data,jsonp:bJSONP,dataType:bJSONP?"jsonp":"json",jsonpCallback:data["$callback"],cache:false,beforeSend:function(request){request.setRequestHeader("Authorization","Bearer "+$.cookie("auth"))},success:function(data){var oDataSource={};oDataSource.aaData=data.value||data.d&&data.d.results||data.d;var iCount=data["@odata.count"]?data["@odata.count"]:data["odata.count"]?data["odata.count"]:data.__count?data.__count:data.d&&data.d.__count;if(iCount==null){if(oDataSource.aaData.length===oSettings._iDisplayLength){oDataSource.iTotalRecords=oSettings._iDisplayStart+oSettings._iDisplayLength+1}else{oDataSource.iTotalRecords=oSettings._iDisplayStart+oDataSource.aaData.length}}else{oDataSource.iTotalRecords=iCount}oDataSource.iTotalDisplayRecords=oDataSource.iTotalRecords;fnCallback(oDataSource)}}))}